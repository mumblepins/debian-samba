Description: Drop unneeded calls to CUPS server
 Don't try to contact the CUPS server when we can reliably
 determine that no printers are needed
Author: Steve Langasek <vorlon@debian.org>
Bug-Debian: http://bugs.debian.org/479512
Bug: https://bugzilla.samba.org/show_bug.cgi?id=5525
Forwarded: yes

Index: b/source3/smbd/server.c
===================================================================
--- a/source3/smbd/server.c	2009-11-08 15:54:27.000000000 +0100
+++ b/source3/smbd/server.c	2009-11-08 15:55:36.000000000 +0100
@@ -699,6 +699,10 @@
 	int pnum = lp_servicenumber(PRINTERS_NAME);
 	const char *pname;
 
+	if (!lp_load_printers()
+	    && (lp_auto_services() == NULL || !strcmp(lp_auto_services(),"")))
+		return;
+
 	pcap_cache_reload();
 
 	/* remove stale printers */
