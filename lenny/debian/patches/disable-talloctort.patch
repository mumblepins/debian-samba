From 258bc9bd60cc6ce5c11ff9ba24db0229ed6980f6 Mon Sep 17 00:00:00 2001
Author: Stefan Metzmacher <metze@samba.org>, Steve Langasek <vorlon@debian.org>
Date: Sun, 20 Sep 2009 19:14:51 +0200
Bug-Debian: #546828
Description: [PATCH] s3:build: only build talloctort if we build talloc
 This should fix bug #6742.

 metze

Index: samba-deb.clean/source3/Makefile.in
===================================================================
--- samba-deb.clean.orig/source3/Makefile.in
+++ samba-deb.clean/source3/Makefile.in
@@ -212,15 +212,15 @@
 TORTURE_PROGS = bin/smbtorture@EXEEXT@ bin/msgtest@EXEEXT@ \
 	bin/masktest@EXEEXT@ bin/locktest@EXEEXT@ \
 	bin/locktest2@EXEEXT@ bin/nsstest@EXEEXT@ bin/vfstest@EXEEXT@ \
-	bin/pdbtest@EXEEXT@ bin/talloctort@EXEEXT@ bin/replacetort@EXEEXT@ \
+	bin/pdbtest@EXEEXT@ bin/replacetort@EXEEXT@ \
 	bin/tdbtorture@EXEEXT@ \
-	bin/smbconftort@EXEEXT@ bin/vlp@EXEEXT@
+	bin/smbconftort@EXEEXT@ bin/vlp@EXEEXT@ @TALLOCTORT@
 
 BIN_PROGS = @EXTRA_BIN_PROGS@ \
 	$(BIN_PROGS1) $(BIN_PROGS2) $(BIN_PROGS3) $(BIN_PROGS4) 
 
 EVERYTHING_PROGS = bin/debug2html@EXEEXT@ bin/smbfilter@EXEEXT@ \
-	bin/talloctort@EXEEXT@ bin/replacetort@EXEEXT@ \
+	@TALLOCTORT@ bin/replacetort@EXEEXT@ \
 	bin/log2pcap@EXEEXT@ \
 	bin/vlp@EXEEXT@ bin/smbiconv@EXEEXT@ \
 	bin/dbwrap_tool@EXEEXT@
@@ -1248,7 +1248,7 @@
 
 sharesec: SHOWFLAGS bin/sharesec@EXEEXT@
 
-talloctort : SHOWFLAGS bin/talloctort@EXEEXT@
+talloctort : SHOWFLAGS @TALLOCTORT@
 
 replacetort : SHOWFLAGS bin/replacetort@EXEEXT@
 
Index: samba-deb.clean/source3/configure.in
===================================================================
--- samba-deb.clean.orig/source3/configure.in
+++ samba-deb.clean/source3/configure.in
@@ -4752,6 +4752,8 @@
 		LIBTALLOC_OBJ0="${LIBTALLOC_OBJ0} ${tallocdir}/${obj}"
 	done
 	AC_SUBST(LIBTALLOC_OBJ0)
+	TALLOCTORT="bin/talloctort"
+	AC_SUBST(TALLOCTORT)
 else
 	LIBTALLOC_LIBS="${TALLOC_LIBS}"
 fi
Index: samba-deb.clean/source3/script/tests/test_local_s3.sh
===================================================================
--- samba-deb.clean.orig/source3/script/tests/test_local_s3.sh
+++ samba-deb.clean/source3/script/tests/test_local_s3.sh
@@ -16,8 +16,10 @@
 
 failed=0
 
-testit "talloctort" $VALGRIND $BINDIR/talloctort || \
-    failed=`expr $failed + 1`
+test -x $BINDIR/talloctort && {
+	testit "talloctort" $VALGRIND $BINDIR/talloctort || \
+	    failed=`expr $failed + 1`
+}
 
 testit "replacetort" $VALGRIND $BINDIR/replacetort || \
     failed=`expr $failed + 1`
