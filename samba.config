#/bin/sh -e
#
# $Id$
#

# Source debconf library.
. /usr/share/debconf/confmodule

db_title "Samba Server"

# Babysit users who don't read README.Debian
if [ -n "$2" ] && dpkg --compare-versions "$2" lt "2.2"
then
	db_input medium samba/log_files_moved || true
	db_go
fi

db_input medium samba/run_mode || true
db_go


# Offer to move the password database for existing users
if [ -e /etc/samba/smbpasswd -a ! -e /etc/samba/passdb.tdb ]; then
	FILE=/etc/samba/smb.conf
	PASSDB=""
	if [ -f "$FILE" ]; then
		PASSDB=`grep -i '^[[:space:]]*passdb backend[[:space:]]*=' $FILE \
		 | sed -e's/^[[:space:]]*passdb backend[[:space:]]*=[[:space:]]*//i' \
		 | tail -1`
	fi
	TDBPRIORITY=medium
	if echo "$PASSDB" | grep -q tdbsam; then
		db_set samba/tdbsam "true"
		TDBPRIORITY=low
	fi
	if echo "$PASSDB" | grep -q ldapsam; then
		db_set samba/tdbsam "false"
		TDBPRIORITY=low
	fi
	db_input "$TDBPRIORITY" samba/tdbsam || true
fi

# We vary the priority of the next question depending on whether
#	the password database already exists...
if [ -e /etc/samba/smbpasswd -o -e /etc/samba/passdb.tdb ]; then
	PRIORITY="low"
else
	# If 'encrypt passwords' is true in smb.conf, and smbpasswd
	# does not exist, default to yes here.
	FILE=/etc/samba/smb.conf
	if [ -f "$FILE" ]; then
		ENCRYPT=`grep -i '^[[:space:]]*encrypt passwords[[:space:]]*=' $FILE \
                 | sed -e's/^[[:space:]]*encrypt passwords[[:space:]]*=[[:space:]]*//i' \
                 | tail -1`
	        if [ "$ENCRYPT" ]; then
			ENCRYPT=`echo $ENCRYPT | tr '[A-Z]' '[a-z]'`
			if [ "$ENCRYPT" = "yes" ]; then
				ENCRYPT=true
			fi
			if [ "$ENCRYPT" = "no" ]; then
				ENCRYPT=false
			fi
		fi
                db_set samba/generate_smbpasswd "$ENCRYPT"
        fi
	PRIORITY="medium"
fi

db_input $PRIORITY samba/generate_smbpasswd || true
db_go
