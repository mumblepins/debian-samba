diff -uNr samba-2.2.3a.orig/source/lib/util_unistr.c samba-2.2.3a/source/lib/util_unistr.c
--- samba-2.2.3a.orig/source/lib/util_unistr.c	2002-02-02 18:46:43.000000000 -0600
+++ samba-2.2.3a/source/lib/util_unistr.c	2002-11-05 12:02:24.000000000 -0600
@@ -174,6 +174,7 @@
  len is the filename length (ignoring any terminating zero) in uin16
  units. Always null terminates.
  Hack alert: uses fixed buffer(s).
+ len is in 2 byte (unicode) units.
 ********************************************************************/
 
 char *dos_unistrn2(uint16 *src, int len)
@@ -426,6 +427,7 @@
  codepage string.
  Return number of unicode chars copied, excluding the null character.
  Unicode strings created are in little-endian format.
+ max_len is in bytes.
 ********************************************************************/
 
 size_t dos_struni2(char *dst, const char *src, size_t max_len)
@@ -436,7 +438,7 @@
 		return 0;
 
 	if (src != NULL) {
-		for (; (len < max_len-2) && *src; len++, dst +=2) {
+		for (; ((len*2) < max_len-2) && *src; len++, dst +=2) {
 			size_t skip = get_character_len(*src);
 			smb_ucs2_t val = (*src & 0xff);
 
diff -uNr samba-2.2.3a.orig/source/libsmb/smbencrypt.c samba-2.2.3a/source/libsmb/smbencrypt.c
--- samba-2.2.3a.orig/source/libsmb/smbencrypt.c	2002-02-02 18:46:44.000000000 -0600
+++ samba-2.2.3a/source/libsmb/smbencrypt.c	2002-11-05 12:04:47.000000000 -0600
@@ -58,12 +58,8 @@
 	int len;
 	int16 wpwd[129];
 	
-	/* Password cannot be longer than 128 characters */
-	len = strlen((char *)passwd);
-	if(len > 128)
-		len = 128;
 	/* Password must be converted to NT unicode - null terminated. */
-	dos_struni2((char *)wpwd, (const char *)passwd, 256);
+	dos_struni2((char *)wpwd, (const char *)passwd, sizeof(wpwd));
 	/* Calculate length in bytes */
 	len = strlen_w((const smb_ucs2_t *)wpwd) * sizeof(int16);
 
@@ -265,7 +261,7 @@
 	}
 	
 	uni_pw_len = byte_len/2;
-	pw = dos_unistrn2((uint16 *)(&in_buffer[512 - byte_len]), byte_len);
+	pw = dos_unistrn2((uint16 *)(&in_buffer[512 - byte_len]), uni_pw_len);
 	memcpy(passwd, pw, uni_pw_len);
 
 #ifdef DEBUG_PASSWORD
diff -uNr samba-2.2.3a.orig/source/msdfs/msdfs.c samba-2.2.3a/source/msdfs/msdfs.c
--- samba-2.2.3a.orig/source/msdfs/msdfs.c	2002-02-02 18:46:44.000000000 -0600
+++ samba-2.2.3a/source/msdfs/msdfs.c	2002-11-05 12:03:41.000000000 -0600
@@ -417,7 +417,7 @@
 
 	DEBUG(10,("setting up version2 referral\nRequested path:\n"));
 
-	requestedpathlen = (dos_struni2(uni_requestedpath,pathname,512)+1)*2;
+	requestedpathlen = (dos_struni2(uni_requestedpath,pathname,1024)+1)*2;
 
 	dump_data(10,uni_requestedpath,requestedpathlen);
 
@@ -482,7 +482,7 @@
 		SSVAL(pdata,offset+16,uni_reqpathoffset1-offset);
 		SSVAL(pdata,offset+18,uni_reqpathoffset2-offset);
 		/* copy referred path into current offset */
-		unilen = (dos_struni2(pdata+uni_curroffset,ref->alternate_path,512) +1)*2;
+		unilen = (dos_struni2(pdata+uni_curroffset,ref->alternate_path,requestedpathlen) +1)*2;
 		SSVAL(pdata,offset+20,uni_curroffset-offset);
 
 		uni_curroffset += unilen;
@@ -510,7 +510,7 @@
 	
 	DEBUG(10,("setting up version3 referral\n"));
 
-	reqpathlen = (dos_struni2(uni_reqpath,pathname,512)+1)*2;
+	reqpathlen = (dos_struni2(uni_reqpath,pathname,1024)+1)*2;
 	
 	dump_data(10,uni_reqpath,reqpathlen);
 
@@ -560,7 +560,7 @@
 		SSVAL(pdata,offset+12,uni_reqpathoffset1-offset);
 		SSVAL(pdata,offset+14,uni_reqpathoffset2-offset);
 		/* copy referred path into current offset */
-		unilen = (dos_struni2(pdata+uni_curroffset,ref->alternate_path,512) +1)*2;
+		unilen = (dos_struni2(pdata+uni_curroffset,ref->alternate_path,reqpathlen) +1)*2;
 		SSVAL(pdata,offset+16,uni_curroffset-offset);
 		/* copy 0x10 bytes of 00's in the ServiceSite GUID */
 		memset(pdata+offset+18,'\0',16);
