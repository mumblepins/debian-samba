http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CAN-2004-1154

Integer overflows


diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/aparser/parser.c samba-2.2.3a/source/aparser/parser.c
--- samba-2.2.3a.orig/source/aparser/parser.c	2000-06-09 04:59:49.000000000 +0200
+++ samba-2.2.3a/source/aparser/parser.c	2005-03-20 12:07:24.000000000 +0100
@@ -1,4 +1,6 @@
 #include "parser.h"
+#include <limits.h>
+
 
 /*******************************************************************
  Attempt, if needed, to grow a data buffer.
@@ -44,6 +46,17 @@ BOOL io_grow(io_struct *ps, uint32 extra
 		 * If the current buffer size is bigger than the space needed, just 
 		 * double it, else add extra_space.
 		 */
+		if(ps->buffer_size >= UINT_MAX/2)
+		{
+			DEBUG(0,("io_grow: integer overflow detected.\n"));
+			return False;
+		}
+		if(ps->buffer_size >= UINT_MAX - extra_space)
+		{
+			DEBUG(0,("io_grow: integer overflow detected.\n"));
+			return False;
+		}
+
 		new_size = MAX(ps->buffer_size*2, ps->buffer_size + extra_space);		
 
 		if ((new_data = Realloc(ps->data_p, new_size)) == NULL) {
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/auth/pampass.c samba-2.2.3a/source/auth/pampass.c
--- samba-2.2.3a.orig/source/auth/pampass.c	2002-02-01 23:12:42.000000000 +0100
+++ samba-2.2.3a/source/auth/pampass.c	2005-03-20 12:07:24.000000000 +0100
@@ -126,7 +126,7 @@ static int smb_pam_conv(int num_msg,
 		return PAM_CONV_ERR;
 	}
 
-	reply = malloc(sizeof(struct pam_response) * num_msg);
+	reply = malloc_array(sizeof(struct pam_response), num_msg);
 	if (!reply)
 		return PAM_CONV_ERR;
 
@@ -286,7 +286,7 @@ static int smb_pam_passchange_conv(int n
 		return PAM_CONV_ERR;
 	}
 
-	reply = malloc(sizeof(struct pam_response) * num_msg);
+	reply = malloc_array(sizeof(struct pam_response), num_msg);
 	if (!reply) {
 		DEBUG(0,("smb_pam_passchange_conv: malloc for reply failed!\n"));
 		free_pw_chat(pw_chat);
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/client/client.c samba-2.2.3a/source/client/client.c
--- samba-2.2.3a.orig/source/client/client.c	2005-03-20 12:05:55.000000000 +0100
+++ samba-2.2.3a/source/client/client.c	2005-03-20 12:07:24.000000000 +0100
@@ -422,6 +422,12 @@ static void add_to_do_list_queue(const c
 	long new_end = do_list_queue_end + ((long)strlen(entry)) + 1;
 	while (new_end > do_list_queue_size)
 	{
+		if(do_list_queue_size >= UINT_MAX/2)
+		{
+			DEBUG(0,("add_to_do_list_queue: integer overflow detected.\n"));
+			reset_do_list_queue();
+			return;
+		}
 		do_list_queue_size *= 2;
 		DEBUG(4,("enlarging do_list_queue to %d\n",
 			 (int)do_list_queue_size));
@@ -2038,7 +2044,7 @@ static char **completion_fn(const char *
 	/* for words not at the start of the line fallback to filename completion */
 	if (start) return NULL;
 
-	matches = (char **)malloc(sizeof(matches[0])*MAX_COMPLETIONS);
+	matches = (char **)malloc_array(sizeof(matches[0]), MAX_COMPLETIONS);
 	if (!matches) return NULL;
 
 	matches[count++] = strdup(text);
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/client/clitar.c samba-2.2.3a/source/client/clitar.c
--- samba-2.2.3a.orig/source/client/clitar.c	2002-02-03 01:46:38.000000000 +0100
+++ samba-2.2.3a/source/client/clitar.c	2005-03-20 12:07:24.000000000 +0100
@@ -109,7 +109,7 @@ BOOL tar_real_noisy=False;  /* Don't wan
 
 char tar_type='\0';
 static char **cliplist=NULL;
-static int clipn=0;
+static unsigned int clipn=0;
 static BOOL must_free_cliplist = False;
 
 extern file_info def_finfo;
@@ -153,6 +153,12 @@ static char *string_create_s(int size)
 {
   char *tmp;
 
+  if(size >= INT_MAX-1)
+  {
+	DEBUG(0, ("string_create_s: integer overflow detected."));
+	return NULL;
+  }
+
   tmp = (char *)malloc(size+1);
 
   if (tmp == NULL) {
@@ -183,6 +189,12 @@ static void writetarheader(int f,  char 
   if (l >= NAMSIZ - 1) {
 	  /* write a GNU tar style long header */
 	  char *b;
+	
+	  if(l >= (INT_MAX - TBLOCK - 100))
+	  {
+		DEBUG(0,("writetarheader: integer overflow detected.\n"));
+		exit(1);
+	  }
 	  b = (char *)malloc(l+TBLOCK+100);
 	  if (!b) {
 		  DEBUG(0,("out of memory\n"));
@@ -384,7 +396,13 @@ static void initarbuf(void)
 {
   /* initialize tar buffer */
   tbufsiz=blocksize*TBLOCK;
-  tarbuf=malloc(tbufsiz);      /* FIXME: We might not get the buffer */
+  tarbuf=malloc(tbufsiz);
+
+  if(tarbuf == NULL)
+  {
+	DEBUG(0,("initarbuf: out of memory.\n"));
+	exit(-1);
+  }
 
   /* reset tar buffer pointer and tar file counter and total dumped */
   tp=0; ntarf=0; ttarf=0;
@@ -1121,11 +1139,19 @@ static int get_dir(file_info2 finfo)
 */
 static char * get_longfilename(file_info2 finfo)
 {
-  int namesize = finfo.size + strlen(cur_dir) + 2;
+  size_t namesize = finfo.size + strlen(cur_dir) + 2;
   char *longname = malloc(namesize);
   int offset = 0, left = finfo.size;
   BOOL first = True;
 
+  if(finfo.size >= (UINT_MAX - strlen(cur_dir) - 2))
+  {
+    DEBUG(0,("get_longfilename: integer overflow detected.\n"));
+    return(NULL);
+  }
+  namesize = finfo.size + strlen(cur_dir) + 2;
+  longname = malloc(namesize);
+
   DEBUG(5, ("Restoring a long file name: %s\n", finfo.name));
   DEBUG(5, ("Len = %d\n", (int)finfo.size));
 
@@ -1573,7 +1599,7 @@ static int read_inclusion_file(char *fil
   FILE *inclusion = NULL;
   char buf[MAXPATHLEN + 1];
   char *inclusion_buffer = NULL;
-  int inclusion_buffer_size = 0;
+  size_t inclusion_buffer_size = 0;
   int inclusion_buffer_sofar = 0;
   char *p;
   char *tmpstr;
@@ -1606,6 +1632,11 @@ static int read_inclusion_file(char *fil
     
     if ((strlen(buf) + 1 + inclusion_buffer_sofar) >= inclusion_buffer_size) {
       char *ib;
+      if(inclusion_buffer_size >= UINT_MAX/2)
+      {
+        DEBUG(0,("read_inclusion_file: integer overflow detected.\n"));
+        return 0;
+      }
       inclusion_buffer_size *= 2;
       ib = Realloc(inclusion_buffer,inclusion_buffer_size);
       if (! ib) {
@@ -1618,13 +1649,24 @@ static int read_inclusion_file(char *fil
     
     safe_strcpy(inclusion_buffer + inclusion_buffer_sofar, buf, inclusion_buffer_size - inclusion_buffer_sofar);
     inclusion_buffer_sofar += strlen(buf) + 1;
+
+    if(clipn > (UINT_MAX-1))
+    {
+      DEBUG(0,("read_inclusion_file: integer overflow detected.\n"));
+      abort();
+    }
     clipn++;
   }
   fclose(inclusion);
 
   if (! error) {
     /* Allocate an array of clipn + 1 char*'s for cliplist */
-    cliplist = malloc((clipn + 1) * sizeof(char *));
+    if(clipn > (UINT_MAX-1))
+    {
+      DEBUG(0,("read_inclusion_file: integer overflow detected.\n"));
+      abort();
+    }
+    cliplist = malloc_array((clipn + 1), sizeof(char *));
     if (cliplist == NULL) {
       DEBUG(0,("failure allocating memory for cliplist\n"));
       error = 1;
@@ -1794,13 +1836,13 @@ int tar_parseargs(int argc, char *argv[]
   } else if (Optind+1<argc && !tar_re_search) { /* For backwards compatibility */
     char *tmpstr;
     char **tmplist;
-    int clipcount;
+    unsigned int clipcount;
 
     cliplist=argv+Optind+1;
     clipn=argc-Optind-1;
     clipcount = clipn;
 
-    if ((tmplist=malloc(clipn*sizeof(char *))) == NULL) {
+    if ((tmplist=malloc_array(clipn, sizeof(char *))) == NULL) {
       DEBUG(0, ("Could not allocate space to process cliplist, count = %i\n", 
                clipn)
            );
@@ -1834,18 +1876,18 @@ int tar_parseargs(int argc, char *argv[]
     if ((preg = (regex_t *)malloc(65536)) == NULL) {
 
       DEBUG(0, ("Could not allocate buffer for regular expression search\n"));
-      return;
+      return 0;
 
     }
 
-    if (errcode = regcomp(preg, argv[Optind + 1], REG_EXTENDED)) {
+    if ((errcode = regcomp(preg, argv[Optind + 1], REG_EXTENDED))) {
       char errstr[1024];
       size_t errlen;
 
       errlen = regerror(errcode, preg, errstr, sizeof(errstr) - 1);
       
       DEBUG(0, ("Could not compile pattern buffer for re search: %s\n%s\n", argv[Optind + 1], errstr));
-      return;
+      return 0;
 
     }
 #endif
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/groupdb/aliasdb.c samba-2.2.3a/source/groupdb/aliasdb.c
--- samba-2.2.3a.orig/source/groupdb/aliasdb.c	2002-02-03 01:46:38.000000000 +0100
+++ samba-2.2.3a/source/groupdb/aliasdb.c	2005-03-20 12:07:24.000000000 +0100
@@ -143,6 +143,13 @@ BOOL add_domain_alias(LOCAL_GRP **alss, 
 	if (alss == NULL || num_alss == NULL || als == NULL)
 		return False;
 
+	if( (*num_alss) == INT_MAX || ((*num_alss)+1) >= UINT_MAX/sizeof(LOCAL_GRP))
+	{
+		DEBUG(0,("add_domain_alias: integer overflow detected.\n"));
+		if (*alss)
+			 free(*alss);
+		return False;
+	}
 	talss = (LOCAL_GRP *)Realloc((*alss), ((*num_alss)+1) * sizeof(LOCAL_GRP));
     if (talss == NULL) {
 		if (*alss)
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/groupdb/aliasfile.c samba-2.2.3a/source/groupdb/aliasfile.c
--- samba-2.2.3a.orig/source/groupdb/aliasfile.c	2002-02-03 01:46:38.000000000 +0100
+++ samba-2.2.3a/source/groupdb/aliasfile.c	2005-03-20 12:07:24.000000000 +0100
@@ -128,6 +128,14 @@ static char *get_alias_members(char *p, 
 		DOM_SID sid;
 		uint8 type;
 
+		if((*num_mem) == INT_MAX || ((*num_mem)+1) >= UINT_MAX/sizeof(LOCAL_GRP_MEMBER))
+		{
+			DEBUG(0,("get_alias_memebers: integer overflow detected.\n"));
+			if (*members)
+				free(*members);
+			return NULL;
+		}
+
 		if (lookup_sid(name, &sid, &type)) {
 			mbrs = Realloc((*members), ((*num_mem)+1) * sizeof(LOCAL_GRP_MEMBER));
 			(*num_mem)++;
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/groupdb/groupdb.c samba-2.2.3a/source/groupdb/groupdb.c
--- samba-2.2.3a.orig/source/groupdb/groupdb.c	2002-02-03 01:46:38.000000000 +0100
+++ samba-2.2.3a/source/groupdb/groupdb.c	2005-03-20 12:07:24.000000000 +0100
@@ -141,6 +141,14 @@ BOOL add_domain_group(DOMAIN_GRP **grps,
 	if (grps == NULL || num_grps == NULL || grp == NULL)
 		return False;
 
+	if((*num_grps) == INT_MAX || (*num_grps)+1 >= UINT_MAX/sizeof(DOMAIN_GRP))
+	{
+		DEBUG(0,("add_domain_group: integer overflow detected.\n"));
+		if (*grps)
+			free(*grps);
+		return False;
+	}
+
 	tgrps = (DOMAIN_GRP *)Realloc((*grps), ((*num_grps)+1) * sizeof(DOMAIN_GRP));
 	if (tgrps == NULL) {
 		if (*grps)
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/groupdb/groupfile.c samba-2.2.3a/source/groupdb/groupfile.c
--- samba-2.2.3a.orig/source/groupdb/groupfile.c	2002-02-03 01:46:38.000000000 +0100
+++ samba-2.2.3a/source/groupdb/groupfile.c	2005-03-20 12:07:24.000000000 +0100
@@ -129,6 +129,14 @@ static char *get_group_members(char *p, 
 	{
 		DOMAIN_GRP_MEMBER *mbrs;
 
+		if((*num_mem) == INT_MAX || (*num_mem)+1 >= UINT_MAX/sizeof(DOMAIN_GRP_MEMBER))
+		{
+			DEBUG(0,("get_group_members: integer overflow detected.\n"));
+			if (*members)
+				free(*members);
+			return False;
+		}
+
 		mbrs = (DOMAIN_GRP_MEMBER *)Realloc((*members), ((*num_mem)+1) * sizeof(DOMAIN_GRP_MEMBER));
 		if (mbrs == NULL) {
 			if (*members)
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/include/includes.h samba-2.2.3a/source/include/includes.h
--- samba-2.2.3a.orig/source/include/includes.h	2002-02-03 01:46:39.000000000 +0100
+++ samba-2.2.3a/source/include/includes.h	2005-03-20 12:07:24.000000000 +0100
@@ -145,6 +145,9 @@
 
 #ifdef HAVE_LIMITS_H
 #include <limits.h>
+#else
+#define UINT_MAX	4294967295U
+#define INT_MAX		2147483647
 #endif
 
 #ifdef HAVE_SYS_IOCTL_H
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/include/proto.h samba-2.2.3a/source/include/proto.h
--- samba-2.2.3a.orig/source/include/proto.h	2005-03-20 12:02:22.000000000 +0100
+++ samba-2.2.3a/source/include/proto.h	2005-03-20 12:07:24.000000000 +0100
@@ -995,11 +995,13 @@ const char *sys_dlerror(void);
 
 TALLOC_CTX *talloc_init(void);
 void *talloc(TALLOC_CTX *t, size_t size);
+void *talloc_array(TALLOC_CTX *ctx, size_t el_size, unsigned int count);
 void *talloc_realloc(TALLOC_CTX *t, void *ptr, size_t size);
 void talloc_destroy_pool(TALLOC_CTX *t);
 void talloc_destroy(TALLOC_CTX *t);
 size_t talloc_pool_size(TALLOC_CTX *t);
 void *talloc_zero(TALLOC_CTX *t, size_t size);
+void *talloc_zero_array(TALLOC_CTX *t, size_t el_size, unsigned int count);
 void *talloc_memdup(TALLOC_CTX *t, void *p, size_t size);
 char *talloc_strdup(TALLOC_CTX *t, char *p);
 
@@ -1047,6 +1049,9 @@ struct passwd *smb_getpwnam(char *user, 
 
 /*The following definitions come from  lib/util.c  */
 
+void *malloc_array(size_t el_size, unsigned int count);
+void *calloc_array(size_t size, size_t nmemb);
+void *realloc_array(void *p,size_t el_size, unsigned int count);
 char *tmpdir(void);
 BOOL in_group(gid_t group, gid_t current_gid, int ngroups, gid_t *groups);
 char *Atoic(char *p, int *n, char *c);
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/lib/bitmap.c samba-2.2.3a/source/lib/bitmap.c
--- samba-2.2.3a.orig/source/lib/bitmap.c	2002-02-03 01:46:41.000000000 +0100
+++ samba-2.2.3a/source/lib/bitmap.c	2005-03-20 12:07:24.000000000 +0100
@@ -37,7 +37,7 @@ struct bitmap *bitmap_allocate(int n)
 	if (!bm) return NULL;
 	
 	bm->n = n;
-	bm->b = (uint32 *)malloc(sizeof(bm->b[0])*(n+31)/32);
+	bm->b = (uint32 *)malloc_array(sizeof(bm->b[0]), (n+31)/32);
 	if (!bm->b) {
 		SAFE_FREE(bm);
 		return NULL;
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/lib/hash.c samba-2.2.3a/source/lib/hash.c
--- samba-2.2.3a.orig/source/lib/hash.c	2002-02-03 01:46:41.000000000 +0100
+++ samba-2.2.3a/source/lib/hash.c	2005-03-20 12:07:24.000000000 +0100
@@ -67,7 +67,7 @@ BOOL hash_table_init(hash_table *table, 
 
 	DEBUG(5, ("Hash size = %d.\n", table->size));
 
-	if(!(table->buckets = (ubi_dlList *) malloc(sizeof(ubi_dlList) * table->size))) {
+	if(!(table->buckets = (ubi_dlList *) malloc_array(sizeof(ubi_dlList), table->size))) {
 		DEBUG(0,("hash_table_init: malloc fail !\n"));
 		return False;
 	}
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/lib/messages.c samba-2.2.3a/source/lib/messages.c
--- samba-2.2.3a.orig/source/lib/messages.c	2002-02-03 01:46:42.000000000 +0100
+++ samba-2.2.3a/source/lib/messages.c	2005-03-20 12:07:24.000000000 +0100
@@ -211,6 +211,11 @@ BOOL message_send_pid(pid_t pid, int msg
 	}
 
 	/* we're adding to an existing entry */
+	if(dbuf.dsize >= (UINT_MAX-len) || (dbuf.dsize+len) > (UINT_MAX-sizeof(rec)))
+	{
+		DEBUG(0,("message_send_pid: integer overflow detected.\n"));
+		goto failed;
+	}
 	p = (void *)malloc(dbuf.dsize + len + sizeof(rec));
 	if (!p) goto failed;
 
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/lib/replace.c samba-2.2.3a/source/lib/replace.c
--- samba-2.2.3a.orig/source/lib/replace.c	2002-02-03 01:46:42.000000000 +0100
+++ samba-2.2.3a/source/lib/replace.c	2005-03-20 12:07:24.000000000 +0100
@@ -168,7 +168,7 @@ Corrections by richard.kettlewell@kewill
 	struct group *g;
 	char   *gr;
 	
-	if((grouplst = (gid_t *)malloc(sizeof(gid_t) * max_gr)) == NULL) {
+	if((grouplst = (gid_t *)malloc_array(sizeof(gid_t), max_gr)) == NULL) {
 		DEBUG(0,("initgroups: malloc fail !\n"));
 		return -1;
 	}
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/lib/sysacls.c samba-2.2.3a/source/lib/sysacls.c
--- samba-2.2.3a.orig/source/lib/sysacls.c	2002-02-03 01:46:42.000000000 +0100
+++ samba-2.2.3a/source/lib/sysacls.c	2005-03-20 12:07:24.000000000 +0100
@@ -729,7 +729,7 @@ SMB_ACL_T sys_acl_init(int count)
 	 * acl[] array, this actually allocates an ACL with room
 	 * for (count+1) entries
 	 */
-	if ((a = malloc(sizeof(*a) + count * sizeof(struct acl))) == NULL) {
+	if ((a = malloc_array(sizeof(*a) + count, sizeof(struct acl))) == NULL) {
 		errno = ENOMEM;
 		return NULL;
 	}
@@ -893,7 +893,7 @@ int sys_acl_set_file(const char *name, S
 		 * allocate a temporary buffer for the complete ACL
 		 */
 		acl_count = acc_acl->count + def_acl->count;
-		acl_p = acl_buf = malloc(acl_count * sizeof(acl_buf[0]));
+		acl_p = acl_buf = malloc_array(acl_count, sizeof(acl_buf[0]));
 
 		if (acl_buf == NULL) {
 			sys_acl_free_acl(tmp_acl);
@@ -1355,7 +1355,7 @@ SMB_ACL_T sys_acl_init(int count)
 {
 	SMB_ACL_T	a;
 
-	if (count < 0) {
+	if (count < 0 || count > INT_MAX-sizeof(*a)) {
 		errno = EINVAL;
 		return NULL;
 	}
@@ -1832,7 +1832,7 @@ int sys_acl_set_file(const char *name, S
 		 * allocate a temporary buffer for the complete ACL
 		 */
 		acl_count = acc_acl->count + def_acl->count;
-		acl_p = acl_buf = malloc(acl_count * sizeof(acl_buf[0]));
+		acl_p = acl_buf = malloc_array(acl_count, sizeof(acl_buf[0]));
 
 		if (acl_buf == NULL) {
 			sys_acl_free_acl(tmp_acl);
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/lib/system.c samba-2.2.3a/source/lib/system.c
--- samba-2.2.3a.orig/source/lib/system.c	2002-02-03 01:46:42.000000000 +0100
+++ samba-2.2.3a/source/lib/system.c	2005-03-20 12:07:24.000000000 +0100
@@ -576,7 +576,7 @@ int sys_getgroups(int setlen, gid_t *gid
 	if (setlen == 0)
 		setlen = groups_max();
 
-	if((group_list = (GID_T *)malloc(setlen * sizeof(GID_T))) == NULL) {
+	if((group_list = (GID_T *)malloc_array(setlen, sizeof(GID_T))) == NULL) {
 		DEBUG(0,("sys_getgroups: Malloc fail.\n"));
 		return -1;
 	}
@@ -625,7 +625,7 @@ int sys_setgroups(int setlen, gid_t *gid
 	 * GID_T array of size setlen.
 	 */
 
-	if((group_list = (GID_T *)malloc(setlen * sizeof(GID_T))) == NULL) {
+	if((group_list = (GID_T *)malloc_array(setlen, sizeof(GID_T))) == NULL) {
 		DEBUG(0,("sys_setgroups: Malloc fail.\n"));
 		return -1;    
 	}
@@ -973,7 +973,7 @@ static char **extract_args(const char *c
 	for( argcl = 1; ptr; ptr = strtok(NULL, " \t"))
 		argcl++;
 
-	if((argl = (char **)malloc((argcl + 1) * sizeof(char *))) == NULL)
+	if((argl = (char **)malloc_array((argcl + 1), sizeof(char *))) == NULL)
 		return NULL;
 
 	/*
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/lib/talloc.c samba-2.2.3a/source/lib/talloc.c
--- samba-2.2.3a.orig/source/lib/talloc.c	2002-02-03 01:46:42.000000000 +0100
+++ samba-2.2.3a/source/lib/talloc.c	2005-03-20 12:07:24.000000000 +0100
@@ -75,6 +75,26 @@ void *talloc(TALLOC_CTX *t, size_t size)
 	return p;
 }
 
+#define MAX_TALLOC_SIZE INT_MAX
+void *talloc_array(TALLOC_CTX *ctx, size_t el_size, unsigned int count)
+{
+	if (count >= MAX_TALLOC_SIZE/el_size) {
+		return NULL;
+	}
+	return talloc(ctx, el_size * count);
+}
+
+void *talloc_zero_array(TALLOC_CTX *t, size_t el_size, unsigned int count)
+{
+	void *p = talloc_array(t, el_size, count);
+
+	if (p)
+		memset(p, '\0', el_size*count);
+
+	return p;
+}
+
+
 /* a talloc version of realloc */
 void *talloc_realloc(TALLOC_CTX *t, void *ptr, size_t size)
 {
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/lib/username.c samba-2.2.3a/source/lib/username.c
--- samba-2.2.3a.orig/source/lib/username.c	2002-02-03 01:46:42.000000000 +0100
+++ samba-2.2.3a/source/lib/username.c	2005-03-20 12:07:24.000000000 +0100
@@ -336,7 +336,7 @@ static BOOL user_in_winbind_group_list(c
  		return False;
  	}
  
- 	if ((groups = (gid_t *)malloc(sizeof(gid_t) * num_groups )) == NULL) {
+ 	if ((groups = (gid_t *)malloc_array(sizeof(gid_t), num_groups )) == NULL) {
  		DEBUG(0,("user_in_winbind_group_list: malloc fail.\n"));
  		goto err;
  	}
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/lib/util.c samba-2.2.3a/source/lib/util.c
--- samba-2.2.3a.orig/source/lib/util.c	2005-03-20 12:05:55.000000000 +0100
+++ samba-2.2.3a/source/lib/util.c	2005-03-20 12:07:24.000000000 +0100
@@ -86,6 +86,41 @@ pstring global_myname = "";
 fstring global_myworkgroup = "";
 char **my_netbios_names;
 
+/* a but huge but well... */
+#define MAX_ALLOC_SIZE INT_MAX
+
+/****************************************************************************
+ Type-safe malloc.
+****************************************************************************/
+
+void *malloc_array(size_t el_size, unsigned int count)
+{
+	if (count >= MAX_ALLOC_SIZE/el_size) {
+		return NULL;
+	}
+	return malloc(el_size*count);
+}
+
+/****************************************************************************
+ Type-safe calloc.
+****************************************************************************/
+
+void *calloc_array(size_t size, size_t nmemb)
+{
+	if (nmemb >= MAX_ALLOC_SIZE/size) {
+		return NULL;
+	}
+	return calloc(nmemb, size);
+}
+
+void *realloc_array(void *p,size_t el_size, unsigned int count)
+{
+	if (count >= MAX_ALLOC_SIZE/el_size) {
+ 		return NULL;
+	}
+	return Realloc(p,el_size*count);
+}
+
 
 /****************************************************************************
  Find a suitable temporary directory. The result should be copied immediately
@@ -159,6 +194,12 @@ char *get_numlist(char *p, uint32 **num,
 	while ((p = Atoic(p, &val, ":,")) != NULL && (*p) != ':') {
 		uint32 *tn;
 
+		if((*count) == INT_MAX || ((*count)+1) >= INT_MAX/sizeof(uint32))
+		{
+			DEBUG(0,("get_numlist: integer overflow detected.\n"));
+			SAFE_FREE(*num);
+			return NULL;
+		}
 		tn = Realloc((*num), ((*count)+1) * sizeof(uint32));
 		if (tn == NULL)
 		{
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/lib/util_file.c samba-2.2.3a/source/lib/util_file.c
--- samba-2.2.3a.orig/source/lib/util_file.c	2002-02-03 01:46:42.000000000 +0100
+++ samba-2.2.3a/source/lib/util_file.c	2005-03-20 12:07:24.000000000 +0100
@@ -366,6 +366,13 @@ char *file_pload(char *syscmd, size_t *s
 	total = 0;
 
 	while ((n = read(fd, buf, sizeof(buf))) > 0) {
+		if(total >= UINT_MAX-n)
+		{
+			DEBUG(0,("file_pload: integer overflow detected.\n"));
+			close(fd);
+			SAFE_FREE(p);
+			return NULL;
+		}
 		tp = Realloc(p, total + n + 1);
 		if (!tp) {
 			DEBUG(0,("file_pload: failed to exand buffer!\n"));
@@ -397,6 +404,9 @@ char *fd_load(int fd, size_t *size)
 
 	if (sys_fstat(fd, &sbuf) != 0) return NULL;
 
+	if(sbuf.st_size == UINT_MAX) /* very large file */
+		return NULL;
+
 	p = (char *)malloc(sbuf.st_size+1);
 	if (!p) return NULL;
 
@@ -446,7 +456,7 @@ static char **file_lines_parse(char *p, 
 		if (s[0] == '\n') i++;
 	}
 
-	ret = (char **)malloc(sizeof(ret[0])*(i+2));
+	ret = (char **)malloc_array(sizeof(ret[0]), (i+2));
 	if (!ret) {
 		SAFE_FREE(p);
 		return NULL;
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/lib/util_getent.c samba-2.2.3a/source/lib/util_getent.c
--- samba-2.2.3a.orig/source/lib/util_getent.c	2002-02-03 01:46:42.000000000 +0100
+++ samba-2.2.3a/source/lib/util_getent.c	2005-03-20 12:07:24.000000000 +0100
@@ -89,7 +89,7 @@ struct sys_grent * getgrent_list(void)
 			;
 		
 		/* alloc space for gr_mem string pointers */
-		if ((gent->gr_mem = (char **) malloc((num+1) * sizeof(char *))) == NULL)
+		if ((gent->gr_mem = (char **) malloc_array((num+1), sizeof(char *))) == NULL)
 			goto err;
 
 		memset(gent->gr_mem, '\0', (num+1) * sizeof(char *));
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/lib/util_seaccess.c samba-2.2.3a/source/lib/util_seaccess.c
--- samba-2.2.3a.orig/source/lib/util_seaccess.c	2002-02-03 01:46:42.000000000 +0100
+++ samba-2.2.3a/source/lib/util_seaccess.c	2005-03-20 12:07:24.000000000 +0100
@@ -327,7 +327,7 @@ SEC_DESC_BUF *se_create_child_secdesc(TA
 
 	the_acl = parent_ctr->dacl;
 
-	if (!(new_ace_list = talloc(ctx, sizeof(SEC_ACE) * the_acl->num_aces))) 
+	if (!(new_ace_list = talloc_array(ctx, sizeof(SEC_ACE), the_acl->num_aces))) 
 		return NULL;
 
 	for (i = 0; the_acl && i < the_acl->num_aces; i++) {
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/lib/util_str.c samba-2.2.3a/source/lib/util_str.c
--- samba-2.2.3a.orig/source/lib/util_str.c	2002-02-03 01:46:43.000000000 +0100
+++ samba-2.2.3a/source/lib/util_str.c	2005-03-20 12:07:24.000000000 +0100
@@ -98,7 +98,7 @@ char **toktocliplist(int *ctok, char *se
   *ctok=ictok;
   s=last_ptr;
 
-  if (!(ret=iret=malloc(ictok*sizeof(char *)))) return NULL;
+  if (!(ret=iret=malloc_array(ictok, sizeof(char *)))) return NULL;
   
   while(ictok--) {    
     *iret++=s;
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/lib/util_unistr.c samba-2.2.3a/source/lib/util_unistr.c
--- samba-2.2.3a.orig/source/lib/util_unistr.c	2005-03-20 12:05:55.000000000 +0100
+++ samba-2.2.3a/source/lib/util_unistr.c	2005-03-20 12:07:24.000000000 +0100
@@ -1118,10 +1118,12 @@ smb_ucs2_t *strtok_w(smb_ucs2_t *s1, con
 
 smb_ucs2_t *strdup_w(const smb_ucs2_t *s)
 {
-	size_t newlen = (strlen_w(s)+1)*sizeof(smb_ucs2_t);
-	smb_ucs2_t *newstr = (smb_ucs2_t *)malloc(newlen);
+	size_t newlen;
+	smb_ucs2_t *newstr = (smb_ucs2_t *)malloc_array((strlen_w(s)+1), sizeof(smb_ucs2_t));
+	
     if (newstr == NULL)
         return NULL;
+	newlen = (strlen_w(s)+1)*sizeof(smb_ucs2_t);
     safe_strcpy_w(newstr, s, newlen);
     return newstr;
 }
@@ -1350,7 +1352,7 @@ smb_ucs2_t **toktocliplist_w(int *ctok, 
 	*ctok = ictok;
 	s = last_ptr;
 
-	if (!(ret=iret=malloc(ictok*sizeof(smb_ucs2_t *))))
+	if (!(ret=iret=malloc_array(ictok, sizeof(smb_ucs2_t *))))
 		return NULL;
   
 	while(ictok--) {
@@ -1838,7 +1840,7 @@ BOOL string_init_w(smb_ucs2_t **dest,con
 	if (l == 0)
 		*dest = null_string;
 	else {
-		(*dest) = (smb_ucs2_t *)malloc(sizeof(smb_ucs2_t)*(l+1));
+		(*dest) = (smb_ucs2_t *)malloc_array(sizeof(smb_ucs2_t), (l+1));
 		if ((*dest) == NULL) {
 			DEBUG(0,("Out of memory in string_init_w\n"));
 			return False;
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/libsmb/cli_lsarpc.c samba-2.2.3a/source/libsmb/cli_lsarpc.c
--- samba-2.2.3a.orig/source/libsmb/cli_lsarpc.c	2002-02-03 01:46:43.000000000 +0100
+++ samba-2.2.3a/source/libsmb/cli_lsarpc.c	2005-03-20 12:07:24.000000000 +0100
@@ -280,13 +280,13 @@ NTSTATUS cli_lsa_lookup_sids(struct cli_
 	(*num_names) = r.mapped_count;
 	result = NT_STATUS_OK;
 
-	if (!((*names) = (char **)talloc(mem_ctx, sizeof(char *) * r.mapped_count))) {
+	if (!((*names) = (char **)talloc_array(mem_ctx, sizeof(char *), r.mapped_count))) {
 		DEBUG(0, ("cli_lsa_lookup_sids(): out of memory\n"));
 		result = NT_STATUS_UNSUCCESSFUL;
 		goto done;
 	}
 
-	if (!((*types) = (uint32 *)talloc(mem_ctx, sizeof(uint32) * r.mapped_count))) {
+	if (!((*types) = (uint32 *)talloc_array(mem_ctx, sizeof(uint32), r.mapped_count))) {
 		DEBUG(0, ("cli_lsa_lookup_sids(): out of memory\n"));
 		result = NT_STATUS_UNSUCCESSFUL;
 		goto done;
@@ -384,13 +384,13 @@ NTSTATUS cli_lsa_lookup_names(struct cli
 	(*num_sids) = r.mapped_count;
 	result = NT_STATUS_OK;
 
-	if (!((*sids = (DOM_SID *)talloc(mem_ctx, sizeof(DOM_SID) * r.mapped_count)))) {
+	if (!((*sids = (DOM_SID *)talloc_array(mem_ctx, sizeof(DOM_SID), r.mapped_count)))) {
 		DEBUG(0, ("cli_lsa_lookup_sids(): out of memory\n"));
 		result = NT_STATUS_UNSUCCESSFUL;
 		goto done;
 	}
 
-	if (!((*types = (uint32 *)talloc(mem_ctx, sizeof(uint32) * r.mapped_count)))) {
+	if (!((*types = (uint32 *)talloc_array(mem_ctx, sizeof(uint32), r.mapped_count)))) {
 		DEBUG(0, ("cli_lsa_lookup_sids(): out of memory\n"));
 		result = NT_STATUS_UNSUCCESSFUL;
 		goto done;
@@ -569,7 +569,7 @@ NTSTATUS cli_lsa_enum_trust_dom(struct c
 
 		/* Allocate memory for trusted domain names and sids */
 
-		*domain_names = (char **)talloc(mem_ctx, sizeof(char *) *
+		*domain_names = (char **)talloc_array(mem_ctx, sizeof(char *),
 						r.num_domains);
 
 		if (!*domain_names) {
@@ -578,7 +578,7 @@ NTSTATUS cli_lsa_enum_trust_dom(struct c
 			goto done;
 		}
 
-		*domain_sids = (DOM_SID *)talloc(mem_ctx, sizeof(DOM_SID) *
+		*domain_sids = (DOM_SID *)talloc_array(mem_ctx, sizeof(DOM_SID),
 						 r.num_domains);
 		if (!domain_sids) {
 			DEBUG(0, ("cli_lsa_enum_trust_dom(): out of memory\n"));
@@ -654,19 +654,19 @@ NTSTATUS cli_lsa_enum_privilege(struct c
 	*enum_context = r.enum_context;
 	*count = r.count;
 
-	if (!((*privs_name = (char **)talloc(mem_ctx, sizeof(char *) * r.count)))) {
+	if (!((*privs_name = (char **)talloc_array(mem_ctx, sizeof(char *), r.count)))) {
 		DEBUG(0, ("(cli_lsa_enum_privilege): out of memory\n"));
 		result = NT_STATUS_UNSUCCESSFUL;
 		goto done;
 	}
 
-	if (!((*privs_high = (uint32 *)talloc(mem_ctx, sizeof(uint32) * r.count)))) {
+	if (!((*privs_high = (uint32 *)talloc_array(mem_ctx, sizeof(uint32), r.count)))) {
 		DEBUG(0, ("(cli_lsa_enum_privilege): out of memory\n"));
 		result = NT_STATUS_UNSUCCESSFUL;
 		goto done;
 	}
 
-	if (!((*privs_low = (uint32 *)talloc(mem_ctx, sizeof(uint32) * r.count)))) {
+	if (!((*privs_low = (uint32 *)talloc_array(mem_ctx, sizeof(uint32), r.count)))) {
 		DEBUG(0, ("(cli_lsa_enum_privilege): out of memory\n"));
 		result = NT_STATUS_UNSUCCESSFUL;
 		goto done;
@@ -788,7 +788,7 @@ NTSTATUS cli_lsa_enum_sids(struct cli_st
 
 	/* Return output parameters */
 
-	*sids = (DOM_SID *)talloc(mem_ctx, sizeof(DOM_SID) * r.sids.num_entries);
+	*sids = (DOM_SID *)talloc_array(mem_ctx, sizeof(DOM_SID), r.sids.num_entries);
 	if (!*sids) {
 		DEBUG(0, ("(cli_lsa_enum_sids): out of memory\n"));
 		result = NT_STATUS_UNSUCCESSFUL;
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/libsmb/cli_samr.c samba-2.2.3a/source/libsmb/cli_samr.c
--- samba-2.2.3a.orig/source/libsmb/cli_samr.c	2002-02-03 01:46:43.000000000 +0100
+++ samba-2.2.3a/source/libsmb/cli_samr.c	2005-03-20 12:07:24.000000000 +0100
@@ -504,7 +504,7 @@ NTSTATUS cli_samr_enum_dom_groups(struct
 	*num_dom_groups = r.num_entries2;
 
 	if (!((*dom_groups) = (struct acct_info *)
-	      talloc(mem_ctx, sizeof(struct acct_info) * *num_dom_groups))) {
+	      talloc_array(mem_ctx, sizeof(struct acct_info), *num_dom_groups))) {
 		result = NT_STATUS_UNSUCCESSFUL;
 		goto done;
 	}
@@ -577,7 +577,7 @@ NTSTATUS cli_samr_query_aliasmem(struct 
 
 	*num_mem = r.num_sids;
 
-	if (!(*sids = talloc(mem_ctx, sizeof(DOM_SID) * *num_mem))) {
+	if (!(*sids = talloc_array(mem_ctx, sizeof(DOM_SID), *num_mem))) {
 		result = NT_STATUS_UNSUCCESSFUL;
 		goto done;
 	}
@@ -805,8 +805,8 @@ NTSTATUS cli_samr_lookup_rids(struct cli
 	}
 
 	*num_names = r.num_names1;
-	*names = talloc(mem_ctx, sizeof(char *) * r.num_names1);
-	*name_types = talloc(mem_ctx, sizeof(uint32) * r.num_names1);
+	*names = talloc_array(mem_ctx, sizeof(char *), r.num_names1);
+	*name_types = talloc_array(mem_ctx, sizeof(uint32), r.num_names1);
 
 	for (i = 0; i < r.num_names1; i++) {
 		fstring tmp;
@@ -873,8 +873,8 @@ NTSTATUS cli_samr_lookup_names(struct cl
 	}
 
 	*num_rids = r.num_rids1;
-	*rids = talloc(mem_ctx, sizeof(uint32) * r.num_rids1);
-	*rid_types = talloc(mem_ctx, sizeof(uint32) * r.num_rids1);
+	*rids = talloc_array(mem_ctx, sizeof(uint32), r.num_rids1);
+	*rid_types = talloc_array(mem_ctx, sizeof(uint32), r.num_rids1);
 
 	for (i = 0; i < r.num_rids1; i++) {
 		(*rids)[i] = r.rids[i];
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/libsmb/cli_spoolss.c samba-2.2.3a/source/libsmb/cli_spoolss.c
--- samba-2.2.3a.orig/source/libsmb/cli_spoolss.c	2002-02-03 01:46:43.000000000 +0100
+++ samba-2.2.3a/source/libsmb/cli_spoolss.c	2005-03-20 12:07:24.000000000 +0100
@@ -178,7 +178,7 @@ static void decode_printer_info_0(
         uint32 i;
         PRINTER_INFO_0  *inf;
 
-        inf=(PRINTER_INFO_0 *)talloc(mem_ctx, returned*sizeof(PRINTER_INFO_0));
+        inf=(PRINTER_INFO_0 *)talloc_array(mem_ctx, returned, sizeof(PRINTER_INFO_0));
 
         buffer->prs.data_offset=0;
 
@@ -199,7 +199,7 @@ static void decode_printer_info_1(
         uint32 i;
         PRINTER_INFO_1  *inf;
 
-        inf=(PRINTER_INFO_1 *)talloc(mem_ctx, returned*sizeof(PRINTER_INFO_1));
+        inf=(PRINTER_INFO_1 *)talloc_array(mem_ctx, returned, sizeof(PRINTER_INFO_1));
 
         buffer->prs.data_offset=0;
 
@@ -220,7 +220,7 @@ static void decode_printer_info_2(
         uint32 i;
         PRINTER_INFO_2  *inf;
 
-        inf=(PRINTER_INFO_2 *)talloc(mem_ctx, returned*sizeof(PRINTER_INFO_2));
+        inf=(PRINTER_INFO_2 *)talloc_array(mem_ctx, returned, sizeof(PRINTER_INFO_2));
 
         buffer->prs.data_offset=0;
 
@@ -243,7 +243,7 @@ static void decode_printer_info_3(
         uint32 i;
         PRINTER_INFO_3  *inf;
 
-        inf=(PRINTER_INFO_3 *)talloc(mem_ctx, returned*sizeof(PRINTER_INFO_3));
+        inf=(PRINTER_INFO_3 *)talloc_array(mem_ctx, returned, sizeof(PRINTER_INFO_3));
 
         buffer->prs.data_offset=0;
 
@@ -268,7 +268,7 @@ static void decode_port_info_1(
         uint32 i;
         PORT_INFO_1 *inf;
 
-        inf=(PORT_INFO_1*)talloc(mem_ctx, returned*sizeof(PORT_INFO_1));
+        inf=(PORT_INFO_1*)talloc_array(mem_ctx, returned, sizeof(PORT_INFO_1));
 
         prs_set_offset(&buffer->prs, 0);
 
@@ -291,7 +291,7 @@ static void decode_port_info_2(
         uint32 i;
         PORT_INFO_2 *inf;
 
-        inf=(PORT_INFO_2*)talloc(mem_ctx, returned*sizeof(PORT_INFO_2));
+        inf=(PORT_INFO_2*)talloc_array(mem_ctx, returned, sizeof(PORT_INFO_2));
 
         prs_set_offset(&buffer->prs, 0);
 
@@ -312,7 +312,7 @@ static void decode_printer_driver_1(
         uint32 i;
         DRIVER_INFO_1 *inf;
 
-        inf=(DRIVER_INFO_1 *)talloc(mem_ctx, returned*sizeof(DRIVER_INFO_1));
+        inf=(DRIVER_INFO_1 *)talloc_array(mem_ctx, returned, sizeof(DRIVER_INFO_1));
 
         buffer->prs.data_offset=0;
 
@@ -333,7 +333,7 @@ static void decode_printer_driver_2(
         uint32 i;
         DRIVER_INFO_2 *inf;
 
-        inf=(DRIVER_INFO_2 *)talloc(mem_ctx, returned*sizeof(DRIVER_INFO_2));
+        inf=(DRIVER_INFO_2 *)talloc_array(mem_ctx, returned, sizeof(DRIVER_INFO_2));
 
         buffer->prs.data_offset=0;
 
@@ -354,7 +354,7 @@ static void decode_printer_driver_3(
         uint32 i;
         DRIVER_INFO_3 *inf;
 
-        inf=(DRIVER_INFO_3 *)talloc(mem_ctx, returned*sizeof(DRIVER_INFO_3));
+        inf=(DRIVER_INFO_3 *)talloc_array(mem_ctx, returned, sizeof(DRIVER_INFO_3));
 
         buffer->prs.data_offset=0;
 
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/libsmb/clilist.c samba-2.2.3a/source/libsmb/clilist.c
--- samba-2.2.3a.orig/source/libsmb/clilist.c	2005-03-20 12:02:22.000000000 +0100
+++ samba-2.2.3a/source/libsmb/clilist.c	2005-03-20 12:07:24.000000000 +0100
@@ -263,6 +263,11 @@ int cli_list_new(struct cli_state *cli,c
 		}
  
 		/* and add them to the dirlist pool */
+		if(dirlist_len >= UINT_MAX - data_len)
+		{
+			DEBUG(0,("cli_list_new: integer overflow detected.\n"));
+			break;
+		}
 		tdl = Realloc(dirlist,dirlist_len + data_len);
 
 		if (!tdl) {
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/libsmb/libsmbclient.c samba-2.2.3a/source/libsmb/libsmbclient.c
--- samba-2.2.3a.orig/source/libsmb/libsmbclient.c	2002-02-03 01:46:44.000000000 +0100
+++ samba-2.2.3a/source/libsmb/libsmbclient.c	2005-03-20 12:07:24.000000000 +0100
@@ -561,7 +561,7 @@ int smbc_init(smbc_get_auth_data_fn fn, 
 
 #endif
 
-	smbc_file_table = malloc(SMBC_MAX_FD * sizeof(struct smbc_file *));
+	smbc_file_table = malloc_array(SMBC_MAX_FD, sizeof(struct smbc_file *));
 	if (!smbc_file_table)
 		return ENOMEM;
 
@@ -621,7 +621,7 @@ int smbc_open(const char *fname, int fla
 	}
 	else {
 	  
-		int slot = 0;
+		unsigned int slot = 0;
 
 		/* Find a free slot first */
 
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/libsmb/namequery.c samba-2.2.3a/source/libsmb/namequery.c
--- samba-2.2.3a.orig/source/libsmb/namequery.c	2002-02-03 01:46:44.000000000 +0100
+++ samba-2.2.3a/source/libsmb/namequery.c	2005-03-20 12:07:24.000000000 +0100
@@ -54,7 +54,7 @@ static struct node_status *parse_node_st
 
 	if (*num_names == 0) return NULL;
 
-	ret = (struct node_status *)malloc(sizeof(struct node_status)* (*num_names));
+	ret = (struct node_status *)malloc_array(sizeof(struct node_status), (*num_names));
 	if (!ret) return NULL;
 
 	p++;
@@ -405,7 +405,16 @@ struct in_addr *name_query(int fd,const 
 				free_packet(p2);
 				continue;
 			}
-
+			if(
+				nmb2->answers->rdlength >= INT_MAX/6 ||
+				(*count) >= INT_MAX-(nmb2->answers->rdlength/6) ||
+				sizeof( ip_list[0] ) >= UINT_MAX/( (*count) + nmb2->answers->rdlength/6 )
+			)
+			{
+				DEBUG(0,("name_query: integer overflow detected.\n"));
+				free_packet(p2);
+				return NULL;
+			}
 			tmp_ip_list = (struct in_addr *)Realloc( ip_list, sizeof( ip_list[0] )
 												* ( (*count) + nmb2->answers->rdlength/6 ) );
 
@@ -1218,7 +1227,7 @@ BOOL get_dc_list(BOOL pdc_only, char *gr
 		if (num_adresses == 0)
 			return internal_resolve_name(group, name_type, ip_list, count);
 
-		return_iplist = (struct in_addr *)malloc(num_adresses * sizeof(struct in_addr));
+		return_iplist = (struct in_addr *)malloc_array(num_adresses, sizeof(struct in_addr));
 		if(return_iplist == NULL) {
 			DEBUG(3,("get_dc_list: malloc fail !\n"));
 			return False;
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/libsmb/nmblib.c samba-2.2.3a/source/libsmb/nmblib.c
--- samba-2.2.3a.orig/source/libsmb/nmblib.c	2002-02-03 01:46:44.000000000 +0100
+++ samba-2.2.3a/source/libsmb/nmblib.c	2005-03-20 12:07:24.000000000 +0100
@@ -335,7 +335,7 @@ static BOOL parse_alloc_res_rec(char *in
 				struct res_rec **recs, int count)
 {
   int i;
-  *recs = (struct res_rec *)malloc(sizeof(**recs)*count);
+  *recs = (struct res_rec *)malloc_array(sizeof(**recs), count);
   if (!*recs) return(False);
 
   memset((char *)*recs,'\0',sizeof(**recs)*count);
@@ -551,7 +551,7 @@ static struct packet_struct *copy_nmb_pa
   if (nmb->answers)
   {
     if((copy_nmb->answers = (struct res_rec *)
-                  malloc(nmb->header.ancount * sizeof(struct res_rec))) == NULL)
+                  malloc_array(nmb->header.ancount, sizeof(struct res_rec))) == NULL)
       goto free_and_exit;
     memcpy((char *)copy_nmb->answers, (char *)nmb->answers, 
            nmb->header.ancount * sizeof(struct res_rec));
@@ -559,7 +559,7 @@ static struct packet_struct *copy_nmb_pa
   if (nmb->nsrecs)
   {
     if((copy_nmb->nsrecs = (struct res_rec *)
-                  malloc(nmb->header.nscount * sizeof(struct res_rec))) == NULL)
+                  malloc_array(nmb->header.nscount, sizeof(struct res_rec))) == NULL)
       goto free_and_exit;
     memcpy((char *)copy_nmb->nsrecs, (char *)nmb->nsrecs, 
            nmb->header.nscount * sizeof(struct res_rec));
@@ -567,7 +567,7 @@ static struct packet_struct *copy_nmb_pa
   if (nmb->additional)
   {
     if((copy_nmb->additional = (struct res_rec *)
-                  malloc(nmb->header.arcount * sizeof(struct res_rec))) == NULL)
+                  malloc_array(nmb->header.arcount, sizeof(struct res_rec))) == NULL)
       goto free_and_exit;
     memcpy((char *)copy_nmb->additional, (char *)nmb->additional, 
            nmb->header.arcount * sizeof(struct res_rec));
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/locking/brlock.c samba-2.2.3a/source/locking/brlock.c
--- samba-2.2.3a.orig/source/locking/brlock.c	2002-02-03 01:46:44.000000000 +0100
+++ samba-2.2.3a/source/locking/brlock.c	2005-03-20 12:07:24.000000000 +0100
@@ -328,6 +328,11 @@ NTSTATUS brl_lock(SMB_DEV_T dev, SMB_INO
 	}
 
 	/* no conflicts - add it to the list of locks */
+	if(dbuf.dsize >= UINT_MAX-sizeof(*locks))
+	{
+		DEBUG(0,("brl_lock: integer overflow detected.\n"));
+		goto fail;
+	}
 	tp = Realloc(dbuf.dptr, dbuf.dsize + sizeof(*locks));
 	if (!tp) {
 		status = NT_STATUS_NO_MEMORY;
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/locking/posix.c samba-2.2.3a/source/locking/posix.c
--- samba-2.2.3a.orig/source/locking/posix.c	2002-02-03 01:46:44.000000000 +0100
+++ samba-2.2.3a/source/locking/posix.c	2005-03-20 12:07:24.000000000 +0100
@@ -371,6 +371,11 @@ static BOOL add_posix_lock_entry(files_s
 	pl.size = size;
 	pl.lock_type = lock_type;
 
+	if(dbuf.dsize >= UINT_MAX - sizeof(pl))
+	{
+		DEBUG(0,("add_posix_lock_entry: integer overflow detected.\n"));
+		goto fail;
+	}
 	tp = Realloc(dbuf.dptr, dbuf.dsize + sizeof(pl));
 	if (!tp) {
 		DEBUG(0,("add_posix_lock_entry: Realloc fail !\n"));
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/msdfs/msdfs.c samba-2.2.3a/source/msdfs/msdfs.c
--- samba-2.2.3a.orig/source/msdfs/msdfs.c	2005-03-20 12:05:55.000000000 +0100
+++ samba-2.2.3a/source/msdfs/msdfs.c	2005-03-20 12:07:24.000000000 +0100
@@ -126,7 +126,7 @@ static inline BOOL parse_symlink(char* b
 
 	DEBUG(10,("parse_symlink: count=%d\n", count));
 
-	reflist = *preflist = (struct referral*) malloc(count * sizeof(struct referral));
+	reflist = *preflist = (struct referral*) malloc_array(count, sizeof(struct referral));
 	if(reflist == NULL) {
 		DEBUG(0,("parse_symlink: Malloc failed!\n"));
 		return False;
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/nmbd/nmbd.c samba-2.2.3a/source/nmbd/nmbd.c
--- samba-2.2.3a.orig/source/nmbd/nmbd.c	2002-02-03 01:46:44.000000000 +0100
+++ samba-2.2.3a/source/nmbd/nmbd.c	2005-03-20 12:07:24.000000000 +0100
@@ -575,7 +575,7 @@ static BOOL init_structs(void)
     namecount++;
 
   /* Allocate space for the netbios aliases */
-  my_netbios_names = (char **)malloc( sizeof(char *) * (namecount+1) );
+  my_netbios_names = (char **)malloc_array( sizeof(char *), (namecount+1) );
   if( NULL == my_netbios_names )
   {
      DEBUG( 0, ( "init_structs: malloc fail.\n" ) );
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/nmbd/nmbd_browsesync.c samba-2.2.3a/source/nmbd/nmbd_browsesync.c
--- samba-2.2.3a.orig/source/nmbd/nmbd_browsesync.c	2002-02-03 01:46:45.000000000 +0100
+++ samba-2.2.3a/source/nmbd/nmbd_browsesync.c	2005-03-20 12:07:24.000000000 +0100
@@ -294,7 +294,7 @@ static void find_domain_master_name_quer
   struct work_record *work;
   struct nmb_name nmbname;
   struct userdata_struct *userdata;
-  int size = sizeof(struct userdata_struct) + sizeof(fstring)+1;
+  size_t size = sizeof(struct userdata_struct) + sizeof(fstring)+1;
 
   if( !(work = find_workgroup_on_subnet(subrec, q_name->name)) )
   {
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/nmbd/nmbd_incomingrequests.c samba-2.2.3a/source/nmbd/nmbd_incomingrequests.c
--- samba-2.2.3a.orig/source/nmbd/nmbd_incomingrequests.c	2002-02-03 01:46:45.000000000 +0100
+++ samba-2.2.3a/source/nmbd/nmbd_incomingrequests.c	2005-03-20 12:07:24.000000000 +0100
@@ -558,7 +558,7 @@ on the same subnet (%s) as the requestor
         prdata = rdata;
       else
       {
-        if((prdata = (char *)malloc( namerec->data.num_ips * 6 )) == NULL)
+        if((prdata = (char *)malloc_array( namerec->data.num_ips, 6 )) == NULL)
         {
           DEBUG(0,("process_name_query_request: malloc fail !\n"));
           goto done;
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/nmbd/nmbd_namelistdb.c samba-2.2.3a/source/nmbd/nmbd_namelistdb.c
--- samba-2.2.3a.orig/source/nmbd/nmbd_namelistdb.c	2002-02-03 01:46:45.000000000 +0100
+++ samba-2.2.3a/source/nmbd/nmbd_namelistdb.c	2005-03-20 12:07:24.000000000 +0100
@@ -195,8 +195,8 @@ struct name_record *add_name_to_subnet( 
   }
 
   memset( (char *)namerec, '\0', sizeof(*namerec) );
-  namerec->data.ip = (struct in_addr *)malloc( sizeof(struct in_addr) 
-                                               * num_ips );
+  namerec->data.ip = (struct in_addr *)malloc_array( sizeof(struct in_addr), 
+                                               num_ips );
   if( NULL == namerec->data.ip )
   {
      DEBUG( 0, ( "add_name_to_subnet: malloc fail when creating ip_flgs.\n" ) );
@@ -336,8 +336,8 @@ void add_ip_to_name_record( struct name_
   if( find_ip_in_name_record( namerec, new_ip ) )
     return;
   
-  new_list = (struct in_addr *)malloc( (namerec->data.num_ips + 1)
-                                       * sizeof(struct in_addr) );
+  new_list = (struct in_addr *)malloc_array( (namerec->data.num_ips + 1),
+                                       sizeof(struct in_addr) );
   if( NULL == new_list )
   {
     DEBUG(0,("add_ip_to_name_record: Malloc fail !\n"));
@@ -492,7 +492,7 @@ void add_samba_names_to_subnet( struct s
     /* Create an IP list containing all our known subnets. */
 
     num_ips = iface_count();
-    iplist = (struct in_addr *)malloc( num_ips * sizeof(struct in_addr) );
+    iplist = (struct in_addr *)malloc_array( num_ips, sizeof(struct in_addr) );
     if( NULL == iplist )
     {
       DEBUG(0,("add_samba_names_to_subnet: Malloc fail !\n"));
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/nmbd/nmbd_nameregister.c samba-2.2.3a/source/nmbd/nmbd_nameregister.c
--- samba-2.2.3a.orig/source/nmbd/nmbd_nameregister.c	2002-02-03 01:46:45.000000000 +0100
+++ samba-2.2.3a/source/nmbd/nmbd_nameregister.c	2005-03-20 12:07:24.000000000 +0100
@@ -276,7 +276,7 @@ static BOOL multihomed_register_name( st
   for(subrec = FIRST_SUBNET; subrec; subrec = NEXT_SUBNET_EXCLUDING_UNICAST(subrec) )
     num_ips++;
 
-  if((ip_list = (struct in_addr *)malloc(num_ips * sizeof(struct in_addr)))==NULL)
+  if((ip_list = (struct in_addr *)malloc_array(num_ips, sizeof(struct in_addr)))==NULL)
   {
     DEBUG(0,("multihomed_register_name: malloc fail !\n"));
     return True;
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/nmbd/nmbd_packets.c samba-2.2.3a/source/nmbd/nmbd_packets.c
--- samba-2.2.3a.orig/source/nmbd/nmbd_packets.c	2002-02-03 01:46:45.000000000 +0100
+++ samba-2.2.3a/source/nmbd/nmbd_packets.c	2005-03-20 12:07:24.000000000 +0100
@@ -1724,7 +1724,12 @@ only use %d.\n", (count*2) + 2, FD_SETSI
     return True;
   }
 
-  if((sock_array = (int *)malloc(((count*2) + 2)*sizeof(int))) == NULL)
+  if(count >= (UINT_MAX/2)-2)
+  {
+    DEBUG(0,("create_listen_fdset: integer overflow detected.\n"));
+    return True;
+  }
+  if((sock_array = (int *)malloc_array(((count*2) + 2), sizeof(int))) == NULL)
   {
     DEBUG(0,("create_listen_fdset: malloc fail for socket array.\n"));
     return True;
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/nmbd/nmbd_winsproxy.c samba-2.2.3a/source/nmbd/nmbd_winsproxy.c
--- samba-2.2.3a.orig/source/nmbd/nmbd_winsproxy.c	2002-02-03 01:46:45.000000000 +0100
+++ samba-2.2.3a/source/nmbd/nmbd_winsproxy.c	2005-03-20 12:07:24.000000000 +0100
@@ -61,7 +61,7 @@ returned for name %s.\n", nmb_namestr(nm
     iplist = &ip;
   else
   {
-    if((iplist = (struct in_addr *)malloc( num_ips * sizeof(struct in_addr) )) == NULL)
+    if((iplist = (struct in_addr *)malloc_array( num_ips, sizeof(struct in_addr) )) == NULL)
     {
       DEBUG(0,("wins_proxy_name_query_request_success: malloc fail !\n"));
       return;
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/nmbd/nmbd_winsserver.c samba-2.2.3a/source/nmbd/nmbd_winsserver.c
--- samba-2.2.3a.orig/source/nmbd/nmbd_winsserver.c	2005-03-20 12:05:55.000000000 +0100
+++ samba-2.2.3a/source/nmbd/nmbd_winsserver.c	2005-03-20 12:07:24.000000000 +0100
@@ -274,7 +274,7 @@ BOOL initialise_wins(void)
     }
 
     /* Allocate the space for the ip_list. */
-    if((ip_list = (struct in_addr *)malloc( num_ips * sizeof(struct in_addr))) == NULL)
+    if((ip_list = (struct in_addr *)malloc_array( num_ips, sizeof(struct in_addr))) == NULL)
     {
       DEBUG(0,("initialise_wins: Malloc fail !\n"));
       return False;
@@ -1239,7 +1239,7 @@ static void process_wins_dmb_query_reque
     return;
   }
 
-  if((prdata = (char *)malloc( num_ips * 6 )) == NULL)
+  if((prdata = (char *)malloc_array( num_ips, 6 )) == NULL)
   {
     DEBUG(0,("process_wins_dmb_query_request: Malloc fail !.\n"));
     return;
@@ -1311,7 +1311,7 @@ void send_wins_name_query_response(int r
       prdata = rdata;
     else
     {
-      if((prdata = (char *)malloc( namerec->data.num_ips * 6 )) == NULL)
+      if((prdata = (char *)malloc_array( namerec->data.num_ips, 6 )) == NULL)
       {
         DEBUG(0,("send_wins_name_query_response: malloc fail !\n"));
         return;
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/nsswitch/wb_common.c samba-2.2.3a/source/nsswitch/wb_common.c
--- samba-2.2.3a.orig/source/nsswitch/wb_common.c	2002-02-03 01:46:45.000000000 +0100
+++ samba-2.2.3a/source/nsswitch/wb_common.c	2005-03-20 12:07:24.000000000 +0100
@@ -293,7 +293,8 @@ int read_reply(struct winbindd_response 
 			sizeof(struct winbindd_response);
 		
 		/* Mallocate memory for extra data */
-		
+		if(extra_data_len <= 0)
+			return -1;
 		if (!(response->extra_data = malloc(extra_data_len))) {
 			return -1;
 		}
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/nsswitch/winbind_nss.c samba-2.2.3a/source/nsswitch/winbind_nss.c
--- samba-2.2.3a.orig/source/nsswitch/winbind_nss.c	2002-02-03 01:46:45.000000000 +0100
+++ samba-2.2.3a/source/nsswitch/winbind_nss.c	2005-03-20 12:07:24.000000000 +0100
@@ -1297,6 +1297,10 @@ _nss_winbind_initgroups_dyn(char *user, 
 
 			/* Add to buffer */
 
+			if ((*size >= INT_MAX/2 - 1) ||
+			    ((2 * (*size) + 1) >= UINT_MAX/sizeof(**groups)))
+				return NSS_STATUS_UNAVAIL;
+
 			if (*start == *size && limit <= 0) {
 				(*groups) = realloc(
 					(*groups), (2 * (*size) + 1) * sizeof(**groups));
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/nsswitch/winbindd_group.c samba-2.2.3a/source/nsswitch/winbindd_group.c
--- samba-2.2.3a.orig/source/nsswitch/winbindd_group.c	2002-02-03 01:46:45.000000000 +0100
+++ samba-2.2.3a/source/nsswitch/winbindd_group.c	2005-03-20 12:07:24.000000000 +0100
@@ -523,6 +523,9 @@ static BOOL get_sam_group_entries(struct
 
 		if (num_entries) {
 
+			if ((ent->num_sam_entries + num_entries) > UINT_MAX/sizeof(struct acct_info))
+				return False;
+
 			tnl = Realloc(name_list,
 				    sizeof(struct acct_info) *
 				    (ent->num_sam_entries +
@@ -593,7 +596,7 @@ enum winbindd_result winbindd_getgrent(s
 	num_groups = MIN(MAX_GETGRENT_GROUPS, state->request.data.num_entries);
 
 	if ((state->response.extra_data = 
-	     malloc(num_groups * sizeof(struct winbindd_gr))) == NULL)
+	     malloc_array(num_groups, sizeof(struct winbindd_gr))) == NULL)
 		return WINBINDD_ERROR;
 
 	state->response.data.num_entries = 0;
@@ -974,7 +977,7 @@ enum winbindd_result winbindd_getgroups(
 	/* Copy data back to client */
 
 	num_gids = 0;
-	gid_list = malloc(sizeof(gid_t) * num_groups);
+	gid_list = malloc_array(sizeof(gid_t), num_groups);
 	if (gid_list == NULL)
 		goto done;
 
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/nsswitch/winbindd_misc.c samba-2.2.3a/source/nsswitch/winbindd_misc.c
--- samba-2.2.3a.orig/source/nsswitch/winbindd_misc.c	2002-02-03 01:46:45.000000000 +0100
+++ samba-2.2.3a/source/nsswitch/winbindd_misc.c	2005-03-20 12:07:24.000000000 +0100
@@ -124,6 +124,12 @@ enum winbindd_result winbindd_list_trust
 		/* Add domain to list */
 
 		total_entries++;
+		if(sizeof(fstring) >= UINT_MAX/total_entries)
+		{
+			DEBUG(0,("winbindd_list_domains: integer overflow detected.\n"));
+			SAFE_FREE(extra_data);
+			return WINBINDD_ERROR;
+		}
 		ted = Realloc(extra_data, sizeof(fstring) * 
                               total_entries);
 
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/nsswitch/winbindd_user.c samba-2.2.3a/source/nsswitch/winbindd_user.c
--- samba-2.2.3a.orig/source/nsswitch/winbindd_user.c	2002-02-03 01:46:46.000000000 +0100
+++ samba-2.2.3a/source/nsswitch/winbindd_user.c	2005-03-20 12:07:24.000000000 +0100
@@ -524,7 +524,7 @@ enum winbindd_result winbindd_getpwent(s
 	num_users = MIN(MAX_GETPWENT_USERS, state->request.data.num_entries);
 	
 	if ((state->response.extra_data = 
-	     malloc(num_users * sizeof(struct winbindd_pw))) == NULL)
+	     malloc_array(num_users, sizeof(struct winbindd_pw))) == NULL)
 		return WINBINDD_ERROR;
 
 	memset(state->response.extra_data, 0, num_users * 
@@ -669,6 +669,13 @@ enum winbindd_result winbindd_list_users
 
 			total_entries += num_entries;
 			
+			if(sizeof(fstring) >= UINT_MAX/total_entries)
+			{
+				DEBUG(0,("winbindd_list_users: integer overflow detected.\n"));
+				SAFE_FREE(extra_data);
+				goto done;
+			}
+
 			ted = Realloc(extra_data, sizeof(fstring) * 
 					     total_entries);
 			
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/pam_smbpass/support.c samba-2.2.3a/source/pam_smbpass/support.c
--- samba-2.2.3a.orig/source/pam_smbpass/support.c	2002-02-03 01:46:46.000000000 +0100
+++ samba-2.2.3a/source/pam_smbpass/support.c	2005-03-20 12:07:25.000000000 +0100
@@ -229,7 +229,7 @@ char * smbpXstrDup( const char *x )
     if (x != NULL) {
         register int i;
 
-        for (i = 0; x[i]; ++i); /* length of string */
+        for (i = 0; x[i] && i < INT_MAX; ++i); /* length of string */
         if ((new = malloc(++i)) == NULL) {
             i = 0;
             _log_err( LOG_CRIT, "out of memory in smbpXstrDup" );
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/param/loadparm.c samba-2.2.3a/source/param/loadparm.c
--- samba-2.2.3a.orig/source/param/loadparm.c	2005-03-20 12:05:55.000000000 +0100
+++ samba-2.2.3a/source/param/loadparm.c	2005-03-20 12:07:24.000000000 +0100
@@ -1831,7 +1831,7 @@ static int add_a_service(service * pserv
 		service **tsp;
 
 #ifdef __INSURE__
-		service **oldservices = iNumServices ? malloc(sizeof(service *) * iNumServices) : NULL;
+		service **oldservices = iNumServices ? malloc_array(sizeof(service *), iNumServices) : NULL;
 
 		if (iNumServices)
 			memcpy(oldservices, ServicePtrs, sizeof(service *) * iNumServices);
@@ -2639,7 +2639,7 @@ static void init_copymap(service * pserv
 {
 	int i;
 	SAFE_FREE(pservice->copymap);
-	pservice->copymap = (BOOL *)malloc(sizeof(BOOL) * NUMPARAMETERS);
+	pservice->copymap = (BOOL *)malloc_array(sizeof(BOOL), NUMPARAMETERS);
 	if (!pservice->copymap)
 		DEBUG(0,
 		      ("Couldn't allocate copymap!! (size %d)\n",
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/passdb/pampass.c samba-2.2.3a/source/passdb/pampass.c
--- samba-2.2.3a.orig/source/passdb/pampass.c	2002-02-03 01:46:48.000000000 +0100
+++ samba-2.2.3a/source/passdb/pampass.c	2005-03-20 12:07:24.000000000 +0100
@@ -126,7 +126,7 @@ static int smb_pam_conv(int num_msg,
 		return PAM_CONV_ERR;
 	}
 
-	reply = malloc(sizeof(struct pam_response) * num_msg);
+	reply = malloc_array(sizeof(struct pam_response), num_msg);
 	if (!reply)
 		return PAM_CONV_ERR;
 
@@ -286,7 +286,7 @@ static int smb_pam_passchange_conv(int n
 		return PAM_CONV_ERR;
 	}
 
-	reply = malloc(sizeof(struct pam_response) * num_msg);
+	reply = malloc_array(sizeof(struct pam_response), num_msg);
 	if (!reply) {
 		DEBUG(0,("smb_pam_passchange_conv: malloc for reply failed!\n"));
 		free_pw_chat(pw_chat);
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/passdb/passdb.c samba-2.2.3a/source/passdb/passdb.c
--- samba-2.2.3a.orig/source/passdb/passdb.c	2002-02-03 01:46:49.000000000 +0100
+++ samba-2.2.3a/source/passdb/passdb.c	2005-03-20 12:07:24.000000000 +0100
@@ -1604,7 +1604,7 @@ BOOL pdb_set_nt_passwd (SAM_ACCOUNT *sam
 	if (sampass->nt_pw!=NULL)
 		DEBUG(4,("pdb_set_nt_passwd: NT hash non NULL overwritting ?\n"));
 	else
-		sampass->nt_pw=(unsigned char *)malloc(sizeof(unsigned char)*16);
+		sampass->nt_pw=(unsigned char *)malloc_array(sizeof(unsigned char), 16);
 	
 	if (sampass->nt_pw==NULL)
 		return False;
@@ -1635,7 +1635,7 @@ BOOL pdb_set_lanman_passwd (SAM_ACCOUNT 
 	if (sampass->lm_pw!=NULL)
 		DEBUG(4,("pdb_set_lanman_passwd: LM hash non NULL overwritting ?\n"));
 	else
-		sampass->lm_pw=(unsigned char *)malloc(sizeof(unsigned char)*16);
+		sampass->lm_pw=(unsigned char *)malloc_array(sizeof(unsigned char), 16);
 	
 	if (sampass->lm_pw==NULL)
 		return False;
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/passdb/pdb_ldap.c samba-2.2.3a/source/passdb/pdb_ldap.c
--- samba-2.2.3a.orig/source/passdb/pdb_ldap.c	2002-02-03 01:46:49.000000000 +0100
+++ samba-2.2.3a/source/passdb/pdb_ldap.c	2005-03-20 12:07:24.000000000 +0100
@@ -325,6 +325,11 @@ static void make_a_mod (LDAPMod *** modl
 
 	if (mods[i] == NULL)
 	{
+		if((i+2) >= INT_MAX/sizeof (LDAPMod *))
+		{
+			DEBUG(0,("make_a_mod: integer overflow detected.\n"));
+			return;
+		}
 		mods = (LDAPMod **) Realloc (mods, (i + 2) * sizeof (LDAPMod *));
 		if (mods == NULL)
 		{
@@ -349,6 +354,11 @@ static void make_a_mod (LDAPMod *** modl
 		if (mods[i]->mod_values != NULL) {
 			for (; mods[i]->mod_values[j] != NULL; j++);
 		}
+		if((j+2) >= INT_MAX/sizeof(char *))
+		{
+			DEBUG(0,("make_a_mod: integer overflow detected.\n"));
+			return;
+		}
 		mods[i]->mod_values = (char **)Realloc(mods[i]->mod_values,
 					       (j + 2) * sizeof (char *));
 					       
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/passdb/pdb_nisplus.c samba-2.2.3a/source/passdb/pdb_nisplus.c
--- samba-2.2.3a.orig/source/passdb/pdb_nisplus.c	2002-02-03 01:46:49.000000000 +0100
+++ samba-2.2.3a/source/passdb/pdb_nisplus.c	2005-03-20 12:07:24.000000000 +0100
@@ -1246,7 +1246,7 @@ BOOL pdb_add_sam_account(SAM_ACCOUNT * n
 
   ta_maxcol = NIS_RES_OBJECT(tblresult)->TA_data.ta_maxcol;
   
-  if(!(ecol = (entry_col*)malloc(ta_maxcol*sizeof(entry_col)))) {
+  if(!(ecol = (entry_col*)malloc_array(ta_maxcol, sizeof(entry_col)))) {
     DEBUG(0, ("memory allocation failure\n"));
     nis_freeresult(tblresult);
     return False;
@@ -1330,7 +1330,7 @@ BOOL pdb_update_sam_account(SAM_ACCOUNT 
   memmove((char *)&new_obj, obj, sizeof (new_obj));
   ta_maxcol = obj->TA_data.ta_maxcol;
   
-  if(!(ecol = (entry_col*)malloc(ta_maxcol*sizeof(entry_col)))) {
+  if(!(ecol = (entry_col*)malloc_array(ta_maxcol, sizeof(entry_col)))) {
     DEBUG(0, ("memory allocation failure\n"));
     nis_freeresult(result);
     return False;
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/printing/nt_printing.c samba-2.2.3a/source/printing/nt_printing.c
--- samba-2.2.3a.orig/source/printing/nt_printing.c	2005-03-20 12:05:55.000000000 +0100
+++ samba-2.2.3a/source/printing/nt_printing.c	2005-03-20 12:07:24.000000000 +0100
@@ -420,7 +420,7 @@ int get_ntforms(nt_forms_struct **list)
 		SAFE_FREE(dbuf.dptr);
 		if (ret != dbuf.dsize) continue;
 
-		tl = Realloc(*list, sizeof(nt_forms_struct)*(n+1));
+		tl = realloc_array(*list, sizeof(nt_forms_struct), (n+1));
 		if (!tl) {
 			DEBUG(0,("get_ntforms: Realloc fail.\n"));
 			return 0;
@@ -491,7 +491,7 @@ BOOL add_a_form(nt_forms_struct **list, 
 	}
 
 	if (update==False) {
-		if((tl=Realloc(*list, (n+1)*sizeof(nt_forms_struct))) == NULL) {
+		if((tl=realloc_array(*list, (n+1), sizeof(nt_forms_struct))) == NULL) {
 			DEBUG(0,("add_a_form: failed to enlarge forms list!\n"));
 			return False;
 		}
@@ -599,7 +599,7 @@ int get_ntdrivers(fstring **list, char *
 	     newkey = tdb_nextkey(tdb_drivers, kbuf), safe_free(kbuf.dptr), kbuf=newkey) {
 		if (strncmp(kbuf.dptr, key, strlen(key)) != 0) continue;
 		
-		if((fl = Realloc(*list, sizeof(fstring)*(total+1))) == NULL) {
+		if((fl = realloc_array(*list, sizeof(fstring), (total+1))) == NULL) {
 			DEBUG(0,("get_ntdrivers: failed to enlarge list!\n"));
 			return -1;
 		}
@@ -1701,7 +1701,7 @@ static WERROR get_a_printer_driver_3_def
 	fstrcpy(info.configfile, "");
 	fstrcpy(info.helpfile, "");
 
-	if ((info.dependentfiles=(fstring *)malloc(2*sizeof(fstring))) == NULL)
+	if ((info.dependentfiles=(fstring *)malloc_array(2, sizeof(fstring))) == NULL)
 		return WERR_NOMEM;
 
 	memset(info.dependentfiles, '\0', 2*sizeof(fstring));
@@ -1755,8 +1755,8 @@ static WERROR get_a_printer_driver_3(NT_
 	while (len < dbuf.dsize) {
 		fstring *tddfs;
 
-		tddfs = (fstring *)Realloc(driver.dependentfiles,
-							 sizeof(fstring)*(i+2));
+		tddfs = (fstring *)realloc_array(driver.dependentfiles,
+							 sizeof(fstring), (i+2));
 		if (tddfs == NULL) {
 			DEBUG(0,("get_a_printer_driver_3: failed to enlarge buffer!\n"));
 			break;
@@ -3478,7 +3478,7 @@ BOOL get_specific_param_by_index(NT_PRIN
 	/* exited because it exist */
 	*type=param->type;		
 	StrnCpy(value, param->value, sizeof(fstring)-1);
-	*data=(uint8 *)malloc(param->data_len*sizeof(uint8));
+	*data=(uint8 *)malloc_array(param->data_len, sizeof(uint8));
 	if(*data == NULL)
 		return False;
 	ZERO_STRUCTP(*data);
@@ -3518,7 +3518,7 @@ BOOL get_specific_param(NT_PRINTER_INFO_
 		/* exited because it exist */
 		*type=param->type;	
 		
-		*data=(uint8 *)malloc(param->data_len*sizeof(uint8));
+		*data=(uint8 *)malloc_array(param->data_len, sizeof(uint8));
 		if(*data == NULL)
 			return False;
 		memcpy(*data, param->data, param->data_len);
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/printing/print_cups.c samba-2.2.3a/source/printing/print_cups.c
--- samba-2.2.3a.orig/source/printing/print_cups.c	2002-02-03 01:46:49.000000000 +0100
+++ samba-2.2.3a/source/printing/print_cups.c	2005-03-20 12:07:24.000000000 +0100
@@ -815,7 +815,7 @@ cups_queue_get(int snum, print_queue_str
 		{
 			qalloc += 16;
 
-			temp = Realloc(queue, sizeof(print_queue_struct) * qalloc);
+			temp = realloc_array(queue, sizeof(print_queue_struct), qalloc);
 
 			if (temp == NULL)
 			{
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/printing/print_generic.c samba-2.2.3a/source/printing/print_generic.c
--- samba-2.2.3a.orig/source/printing/print_generic.c	2002-02-03 01:46:49.000000000 +0100
+++ samba-2.2.3a/source/printing/print_generic.c	2005-03-20 12:07:24.000000000 +0100
@@ -213,7 +213,7 @@ static int generic_queue_get(int snum, p
 	qcount = 0;
 	ZERO_STRUCTP(status);
 	if (numlines)
-		queue = (print_queue_struct *)malloc(sizeof(print_queue_struct)*(numlines+1));
+		queue = (print_queue_struct *)malloc_array(sizeof(print_queue_struct), (numlines+1));
 
 	if (queue) {
 		for (i=0; i<numlines; i++) {
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/printing/printing.c samba-2.2.3a/source/printing/printing.c
--- samba-2.2.3a.orig/source/printing/printing.c	2005-03-20 12:05:55.000000000 +0100
+++ samba-2.2.3a/source/printing/printing.c	2005-03-20 12:07:24.000000000 +0100
@@ -1179,7 +1179,7 @@ int print_queue_status(int snum, 
 
 	/* Allocate the queue size. */
 	if ((tstruct.queue = (print_queue_struct *)
-	     malloc(sizeof(print_queue_struct)*tsc.count))
+	     malloc_array(sizeof(print_queue_struct), tsc.count))
 				== NULL)
 		return 0;
 
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/rpc_parse/parse_lsa.c samba-2.2.3a/source/rpc_parse/parse_lsa.c
--- samba-2.2.3a.orig/source/rpc_parse/parse_lsa.c	2002-02-03 01:46:49.000000000 +0100
+++ samba-2.2.3a/source/rpc_parse/parse_lsa.c	2005-03-20 12:07:24.000000000 +0100
@@ -694,7 +694,7 @@ static BOOL lsa_io_dom_query_2(char *des
 		return False;
 
 	if (UNMARSHALLING(ps)) {
-		d_q->auditsettings = (uint32 *)talloc_zero(ps->mem_ctx, d_q->count2 * sizeof(uint32));
+		d_q->auditsettings = (uint32 *)talloc_zero_array(ps->mem_ctx, d_q->count2, sizeof(uint32));
 	}
 
 	if (d_q->auditsettings == NULL) {
@@ -815,13 +815,13 @@ void init_lsa_sid_enum(TALLOC_CTX *mem_c
 
 	if (num_entries == 0) return;
 
-	if ((sen->ptr_sid = (uint32 *)talloc_zero(mem_ctx, num_entries * 
+	if ((sen->ptr_sid = (uint32 *)talloc_zero_array(mem_ctx, num_entries,
 					     sizeof(uint32))) == NULL) {
 		DEBUG(3, ("init_lsa_sid_enum(): out of memory for ptr_sid\n"));
 		return;
 	}
 
-	if ((sen->sid = (DOM_SID2 *)talloc_zero(mem_ctx, num_entries * 
+	if ((sen->sid = (DOM_SID2 *)talloc_zero_array(mem_ctx, num_entries,
 					   sizeof(DOM_SID2))) == NULL) {
 		DEBUG(3, ("init_lsa_sid_enum(): out of memory for sids\n"));
 		return;
@@ -1065,14 +1065,14 @@ void init_q_lookup_names(TALLOC_CTX *mem
 	q_l->num_entries2 = num_names;
 	q_l->lookup_level = 1;
 
-	if ((q_l->uni_name = (UNISTR2 *)talloc_zero(
-		mem_ctx, num_names * sizeof(UNISTR2))) == NULL) {
+	if ((q_l->uni_name = (UNISTR2 *)talloc_zero_array(
+		mem_ctx, num_names, sizeof(UNISTR2))) == NULL) {
 		DEBUG(3, ("init_q_lookup_names(): out of memory\n"));
 		return;
 	}
 
-	if ((q_l->hdr_name = (UNIHDR *)talloc_zero(
-		mem_ctx, num_names * sizeof(UNIHDR))) == NULL) {
+	if ((q_l->hdr_name = (UNIHDR *)talloc_zero_array(
+		mem_ctx, num_names, sizeof(UNIHDR))) == NULL) {
 		DEBUG(3, ("init_q_lookup_names(): out of memory\n"));
 		return;
 	}
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/rpc_parse/parse_misc.c samba-2.2.3a/source/rpc_parse/parse_misc.c
--- samba-2.2.3a.orig/source/rpc_parse/parse_misc.c	2002-02-03 01:46:50.000000000 +0100
+++ samba-2.2.3a/source/rpc_parse/parse_misc.c	2005-03-20 12:07:24.000000000 +0100
@@ -951,7 +951,7 @@ void init_unistr2_from_unistr (UNISTR2 *
 	to->uni_str_len = i;
 
 	/* allocate the space and copy the string buffer */
-	to->buffer = (uint16 *)talloc_zero(get_talloc_ctx(), sizeof(uint16)*(to->uni_str_len));
+	to->buffer = (uint16 *)talloc_zero_array(get_talloc_ctx(), sizeof(uint16), (to->uni_str_len));
 	if (to->buffer == NULL)
 		smb_panic("init_unistr2_from_unistr: malloc fail\n");
 	memcpy(to->buffer, from->buffer, to->uni_max_len*sizeof(uint16));
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/rpc_parse/parse_net.c samba-2.2.3a/source/rpc_parse/parse_net.c
--- samba-2.2.3a.orig/source/rpc_parse/parse_net.c	2002-02-03 01:46:50.000000000 +0100
+++ samba-2.2.3a/source/rpc_parse/parse_net.c	2005-03-20 12:07:25.000000000 +0100
@@ -824,7 +824,7 @@ static int init_dom_sid2s(TALLOC_CTX *ct
 			;
 
 		/* Now allocate space for them. */
-		*ppsids = (DOM_SID2 *)talloc_zero(ctx, count * sizeof(DOM_SID2));
+		*ppsids = (DOM_SID2 *)talloc_zero_array(ctx, count, sizeof(DOM_SID2));
 		if (*ppsids == NULL)
 			return 0;
 
@@ -1291,7 +1291,7 @@ void init_net_user_info3(TALLOC_CTX *ctx
 	/* always have at least one group == the user's primary group */
 	usr->num_groups2 = num_groups+1;
 
-	usr->gids = (DOM_GID *)talloc_zero(ctx,sizeof(DOM_GID) * (num_groups+1));
+	usr->gids = (DOM_GID *)talloc_zero_array(ctx,sizeof(DOM_GID), (num_groups+1));
 	if (usr->gids == NULL)
 		return;
 
@@ -2127,7 +2127,7 @@ static BOOL net_io_sam_group_mem_info(ch
 			return False;
 		}
 
-                info->rids = talloc(ps->mem_ctx, sizeof(uint32) *
+                info->rids = talloc_array(ps->mem_ctx, sizeof(uint32),
                                     info->num_members2);
 
                 if (info->rids == NULL) {
@@ -2242,7 +2242,7 @@ static BOOL net_io_sam_alias_mem_info(ch
 			return False;
 		}
 
-                info->ptr_sids = talloc(ps->mem_ctx, sizeof(uint32) *
+                info->ptr_sids = talloc_array(ps->mem_ctx, sizeof(uint32),
                                         info->num_sids);
                 
                 if (info->ptr_sids == NULL) {
@@ -2258,7 +2258,7 @@ static BOOL net_io_sam_alias_mem_info(ch
                                 return False;
 		}
 
-                info->sids = talloc(ps->mem_ctx, sizeof(DOM_SID2) *
+                info->sids = talloc_array(ps->mem_ctx, sizeof(DOM_SID2),
                                     info->num_sids);
 
                 if (info->sids == NULL) {
@@ -2400,7 +2400,7 @@ BOOL net_io_r_sam_sync(char *desc, uint8
 
                         if (r_s->num_deltas2 > 0) {
                                 r_s->hdr_deltas = (SAM_DELTA_HDR *)
-                                        talloc(ps->mem_ctx, r_s->num_deltas2 *
+                                        talloc_array(ps->mem_ctx, r_s->num_deltas2,
                                                sizeof(SAM_DELTA_HDR));
                           
                                 if (r_s->hdr_deltas == NULL) {
@@ -2421,7 +2421,7 @@ BOOL net_io_r_sam_sync(char *desc, uint8
 
                         if (r_s->num_deltas2 > 0) {
                                 r_s->deltas = (SAM_DELTA_CTR *)
-                                        talloc(ps->mem_ctx, r_s->num_deltas2 *
+                                        talloc_array(ps->mem_ctx, r_s->num_deltas2,
                                                sizeof(SAM_DELTA_CTR));
 
                                 if (r_s->deltas == NULL) {
@@ -2536,7 +2536,7 @@ BOOL net_io_r_sam_deltas(char *desc, uin
 		{
                         if (r_s->num_deltas > 0) {
                                 r_s->hdr_deltas = (SAM_DELTA_HDR *)
-                                        talloc(ps->mem_ctx, r_s->num_deltas *
+                                        talloc_array(ps->mem_ctx, r_s->num_deltas,
                                                sizeof(SAM_DELTA_HDR));
                                 if (r_s->hdr_deltas == NULL) {
                                         DEBUG(0, ("error tallocating memory "
@@ -2554,7 +2554,7 @@ BOOL net_io_r_sam_deltas(char *desc, uin
                         
                         if (r_s->num_deltas > 0) {
                                 r_s->deltas = (SAM_DELTA_CTR *)
-                                        talloc(ps->mem_ctx, r_s->num_deltas *
+                                        talloc_array(ps->mem_ctx, r_s->num_deltas,
                                                sizeof(SAM_DELTA_CTR));
 
                                 if (r_s->deltas == NULL) {
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/rpc_parse/parse_samr.c samba-2.2.3a/source/rpc_parse/parse_samr.c
--- samba-2.2.3a.orig/source/rpc_parse/parse_samr.c	2002-02-03 01:46:50.000000000 +0100
+++ samba-2.2.3a/source/rpc_parse/parse_samr.c	2005-03-20 12:07:25.000000000 +0100
@@ -1451,11 +1451,11 @@ NTSTATUS init_sam_dispinfo_1(TALLOC_CTX 
 	if (num_entries==0)
 		return NT_STATUS_OK;
 
-	sam->sam=(SAM_ENTRY1 *)talloc(ctx, num_entries*sizeof(SAM_ENTRY1));
+	sam->sam=(SAM_ENTRY1 *)talloc_array(ctx, num_entries, sizeof(SAM_ENTRY1));
 	if (!sam->sam)
 		return NT_STATUS_NO_MEMORY;
 
-	sam->str=(SAM_STR1 *)talloc(ctx, num_entries*sizeof(SAM_STR1));
+	sam->str=(SAM_STR1 *)talloc_array(ctx, num_entries, sizeof(SAM_STR1));
 	if (!sam->str)
 		return NT_STATUS_NO_MEMORY;
 
@@ -1554,10 +1554,10 @@ NTSTATUS init_sam_dispinfo_2(TALLOC_CTX 
 	if (num_entries==0)
 		return NT_STATUS_OK;
 
-	if (!(sam->sam=(SAM_ENTRY2 *)talloc(ctx, num_entries*sizeof(SAM_ENTRY2))))
+	if (!(sam->sam=(SAM_ENTRY2 *)talloc_array(ctx, num_entries, sizeof(SAM_ENTRY2))))
 		return NT_STATUS_NO_MEMORY;
 
-	if (!(sam->str=(SAM_STR2 *)talloc(ctx, num_entries*sizeof(SAM_STR2))))
+	if (!(sam->str=(SAM_STR2 *)talloc_array(ctx, num_entries, sizeof(SAM_STR2))))
 		return NT_STATUS_NO_MEMORY;
 
 	ZERO_STRUCTP(sam->sam);
@@ -1653,10 +1653,10 @@ NTSTATUS init_sam_dispinfo_3(TALLOC_CTX 
 	if (num_entries==0)
 		return NT_STATUS_OK;
 
-	if (!(sam->sam=(SAM_ENTRY3 *)talloc(ctx, num_entries*sizeof(SAM_ENTRY3))))
+	if (!(sam->sam=(SAM_ENTRY3 *)talloc_array(ctx, num_entries, sizeof(SAM_ENTRY3))))
 		return NT_STATUS_NO_MEMORY;
 
-	if (!(sam->str=(SAM_STR3 *)talloc(ctx, num_entries*sizeof(SAM_STR3))))
+	if (!(sam->str=(SAM_STR3 *)talloc_array(ctx, num_entries, sizeof(SAM_STR3))))
 		return NT_STATUS_NO_MEMORY;
 
 	ZERO_STRUCTP(sam->sam);
@@ -1747,10 +1747,10 @@ NTSTATUS init_sam_dispinfo_4(TALLOC_CTX 
 	if (num_entries==0)
 		return NT_STATUS_OK;
 
-	if (!(sam->sam=(SAM_ENTRY4 *)talloc(ctx, num_entries*sizeof(SAM_ENTRY4))))
+	if (!(sam->sam=(SAM_ENTRY4 *)talloc_array(ctx, num_entries, sizeof(SAM_ENTRY4))))
 		return NT_STATUS_NO_MEMORY;
 
-	if (!(sam->str=(SAM_STR4 *)talloc(ctx, num_entries*sizeof(SAM_STR4))))
+	if (!(sam->str=(SAM_STR4 *)talloc_array(ctx, num_entries, sizeof(SAM_STR4))))
 		return NT_STATUS_NO_MEMORY;
 
 	ZERO_STRUCTP(sam->sam);
@@ -1838,10 +1838,10 @@ NTSTATUS init_sam_dispinfo_5(TALLOC_CTX 
 	if (num_entries==0)
 		return NT_STATUS_OK;
 
-	if (!(sam->sam=(SAM_ENTRY5 *)talloc(ctx, num_entries*sizeof(SAM_ENTRY5))))
+	if (!(sam->sam=(SAM_ENTRY5 *)talloc_array(ctx, num_entries, sizeof(SAM_ENTRY5))))
 		return NT_STATUS_NO_MEMORY;
 
-	if (!(sam->str=(SAM_STR5 *)talloc(ctx, num_entries*sizeof(SAM_STR5))))
+	if (!(sam->str=(SAM_STR5 *)talloc_array(ctx, num_entries, sizeof(SAM_STR5))))
 		return NT_STATUS_NO_MEMORY;
 
 	ZERO_STRUCTP(sam->sam);
@@ -3917,7 +3917,7 @@ void init_samr_q_lookup_rids(TALLOC_CTX 
 	q_u->flags = flags;
 	q_u->ptr = 0;
 	q_u->num_rids2 = num_rids;
-	q_u->rid = (uint32 *)talloc_zero(ctx, num_rids * sizeof(q_u->rid[0]));
+	q_u->rid = (uint32 *)talloc_zero_array(ctx, num_rids, sizeof(q_u->rid[0]));
 	if (q_u->rid == NULL) {
 		q_u->num_rids1 = 0;
 		q_u->num_rids2 = 0;
@@ -4549,10 +4549,10 @@ NTSTATUS init_samr_q_lookup_names(TALLOC
 	q_u->ptr = 0;
 	q_u->num_names2 = num_names;
 
-	if (!(q_u->hdr_name = (UNIHDR *)talloc_zero(ctx, num_names * sizeof(UNIHDR))))
+	if (!(q_u->hdr_name = (UNIHDR *)talloc_zero_array(ctx, num_names, sizeof(UNIHDR))))
 		return NT_STATUS_NO_MEMORY;
 
-	if (!(q_u->uni_name = (UNISTR2 *)talloc_zero(ctx, num_names * sizeof(UNISTR2))))
+	if (!(q_u->uni_name = (UNISTR2 *)talloc_zero_array(ctx, num_names, sizeof(UNISTR2))))
 		return NT_STATUS_NO_MEMORY;
 
 	for (i = 0; i < num_names; i++) {
@@ -4641,9 +4641,9 @@ NTSTATUS init_samr_r_lookup_names(TALLOC
 		r_u->ptr_rids = 1;
 		r_u->num_rids2 = num_rids;
 
-		if (!(r_u->rids = (uint32 *)talloc_zero(ctx, sizeof(uint32)*num_rids)))
+		if (!(r_u->rids = (uint32 *)talloc_zero_array(ctx, sizeof(uint32), num_rids)))
 			return NT_STATUS_NO_MEMORY;
-		if (!(r_u->types = (uint32 *)talloc_zero(ctx, sizeof(uint32)*num_rids)))
+		if (!(r_u->types = (uint32 *)talloc_zero_array(ctx, sizeof(uint32), num_rids)))
 			return NT_STATUS_NO_MEMORY;
 
 		if (!r_u->rids || !r_u->types)
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/rpc_parse/parse_sec.c samba-2.2.3a/source/rpc_parse/parse_sec.c
--- samba-2.2.3a.orig/source/rpc_parse/parse_sec.c	2002-02-03 01:46:50.000000000 +0100
+++ samba-2.2.3a/source/rpc_parse/parse_sec.c	2005-03-20 12:07:25.000000000 +0100
@@ -139,7 +139,7 @@ SEC_ACL *make_sec_acl(TALLOC_CTX *ctx, u
 	   positive number. */
 
 	if ((num_aces) && 
-            ((dst->ace = (SEC_ACE *)talloc(ctx, sizeof(SEC_ACE) * num_aces)) 
+            ((dst->ace = (SEC_ACE *)talloc_array(ctx, sizeof(SEC_ACE), num_aces)) 
              == NULL)) {
 		return NULL;
 	}
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/rpc_parse/parse_spoolss.c samba-2.2.3a/source/rpc_parse/parse_spoolss.c
--- samba-2.2.3a.orig/source/rpc_parse/parse_spoolss.c	2002-02-03 01:46:50.000000000 +0100
+++ samba-2.2.3a/source/rpc_parse/parse_spoolss.c	2005-03-20 12:07:25.000000000 +0100
@@ -1796,7 +1796,7 @@ static BOOL smb_io_relarraystr(char *des
 
 			/* Yes this should be malloc not talloc. Don't change. */
 
-			chaine.buffer = malloc((q-p+1)*sizeof(uint16));
+			chaine.buffer = malloc_array((q-p+1), sizeof(uint16));
 			if (chaine.buffer == NULL)
 				return False;
 
@@ -4833,7 +4833,7 @@ static BOOL uniarray_2_dosarray(BUFFER5 
 	while (src < ((char *)buf5->buffer) + buf5->buf_len*2) {
 		unistr_to_dos(f, src, sizeof(f)-1);
 		src = skip_unibuf(src, 2*buf5->buf_len - PTR_DIFF(src,buf5->buffer));
-		tar = (fstring *)Realloc(*ar, sizeof(fstring)*(n+2));
+		tar = (fstring *)realloc_array(*ar, sizeof(fstring), (n+2));
 		if (!tar)
 			return False;
 		else
@@ -5749,7 +5749,7 @@ BOOL convert_specific_param(NT_PRINTER_P
 	(*param)->data_len=len;
 	
 	if (len) {
-		(*param)->data=(uint8 *)malloc(len * sizeof(uint8));
+		(*param)->data=(uint8 *)malloc_array(len, sizeof(uint8));
 		if((*param)->data == NULL)
 			return False;
 		memcpy((*param)->data, data, len);
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/rpc_server/srv_dfs_nt.c samba-2.2.3a/source/rpc_server/srv_dfs_nt.c
--- samba-2.2.3a.orig/source/rpc_server/srv_dfs_nt.c	2002-02-03 01:46:51.000000000 +0100
+++ samba-2.2.3a/source/rpc_server/srv_dfs_nt.c	2005-03-20 12:07:25.000000000 +0100
@@ -80,8 +80,8 @@ WERROR _dfs_add(pipes_struct *p, DFS_Q_D
   else
     jn.referral_count = 1;
 
-  jn.referral_list = (struct referral*) talloc(p->mem_ctx, jn.referral_count 
-					       * sizeof(struct referral));
+  jn.referral_list = (struct referral*) talloc_array(p->mem_ctx, jn.referral_count, 
+					       sizeof(struct referral));
 
   if(jn.referral_list == NULL)
     {
@@ -243,7 +243,7 @@ static BOOL init_reply_dfs_info_3(TALLOC
       dfs3[i].ptr_storages = 1;
      
       /* also enumerate the storages */
-      dfs3[i].storages = (DFS_STORAGE_INFO*) talloc(ctx, j[i].referral_count * 
+      dfs3[i].storages = (DFS_STORAGE_INFO*) talloc_array(ctx, j[i].referral_count, 
 						    sizeof(DFS_STORAGE_INFO));
       if (!dfs3[i].storages)
         return False;
@@ -286,7 +286,7 @@ static WERROR init_reply_dfs_ctr(TALLOC_
     case 1:
       {
 	DFS_INFO_1* dfs1;
-	dfs1 = (DFS_INFO_1*) talloc(ctx, num_jn * sizeof(DFS_INFO_1));
+	dfs1 = (DFS_INFO_1*) talloc_array(ctx, num_jn, sizeof(DFS_INFO_1));
 	if (!dfs1)
 		return WERR_NOMEM;
 	init_reply_dfs_info_1(jn, dfs1, num_jn);
@@ -296,7 +296,7 @@ static WERROR init_reply_dfs_ctr(TALLOC_
     case 2:
       {
 	DFS_INFO_2* dfs2;
-	dfs2 = (DFS_INFO_2*) talloc(ctx, num_jn * sizeof(DFS_INFO_2));
+	dfs2 = (DFS_INFO_2*) talloc_array(ctx, num_jn, sizeof(DFS_INFO_2));
 	if (!dfs2)
 		return WERR_NOMEM;
 	init_reply_dfs_info_2(jn, dfs2, num_jn);
@@ -306,7 +306,7 @@ static WERROR init_reply_dfs_ctr(TALLOC_
     case 3:
       {
 	DFS_INFO_3* dfs3;
-	dfs3 = (DFS_INFO_3*) talloc(ctx, num_jn * sizeof(DFS_INFO_3));
+	dfs3 = (DFS_INFO_3*) talloc_array(ctx, num_jn, sizeof(DFS_INFO_3));
 	if (!dfs3)
 		return WERR_NOMEM;
 	init_reply_dfs_info_3(ctx, jn, dfs3, num_jn);
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/rpc_server/srv_lsa_nt.c samba-2.2.3a/source/rpc_server/srv_lsa_nt.c
--- samba-2.2.3a.orig/source/rpc_server/srv_lsa_nt.c	2002-02-03 01:46:51.000000000 +0100
+++ samba-2.2.3a/source/rpc_server/srv_lsa_nt.c	2005-03-20 12:07:25.000000000 +0100
@@ -217,13 +217,13 @@ static void init_lsa_trans_names(TALLOC_
 	/* Allocate memory for list of names */
 
 	if (num_entries > 0) {
-		if (!(trn->name = (LSA_TRANS_NAME *)talloc(ctx, sizeof(LSA_TRANS_NAME) *
+		if (!(trn->name = (LSA_TRANS_NAME *)talloc_array(ctx, sizeof(LSA_TRANS_NAME),
 							  num_entries))) {
 			DEBUG(0, ("init_lsa_trans_names(): out of memory\n"));
 			return;
 		}
 
-		if (!(trn->uni_name = (UNISTR2 *)talloc(ctx, sizeof(UNISTR2) * 
+		if (!(trn->uni_name = (UNISTR2 *)talloc_array(ctx, sizeof(UNISTR2),
 							num_entries))) {
 			DEBUG(0, ("init_lsa_trans_names(): out of memory\n"));
 			return;
@@ -384,7 +384,7 @@ NTSTATUS _lsa_query_info(pipes_struct *p
 			info->id2.auditing_enabled = 1;
 			info->id2.count1 = 7;
 			info->id2.count2 = 7;
-			if ((info->id2.auditsettings = (uint32 *)talloc(p->mem_ctx,7*sizeof(uint32))) == NULL)
+			if ((info->id2.auditsettings = (uint32 *)talloc_array(p->mem_ctx, 7, sizeof(uint32))) == NULL)
 				return NT_STATUS_NO_MEMORY;
 			for (i = 0; i < 7; i++)
 				info->id2.auditsettings[i] = 3;
@@ -565,7 +565,7 @@ NTSTATUS _lsa_enum_privs(pipes_struct *p
 	if (enum_context >= PRIV_ALL_INDEX)
 		return NT_STATUS_UNABLE_TO_FREE_VM;
 
-	entries = (LSA_PRIV_ENTRY *)talloc_zero(p->mem_ctx, sizeof(LSA_PRIV_ENTRY) * (PRIV_ALL_INDEX-enum_context));
+	entries = (LSA_PRIV_ENTRY *)talloc_zero_array(p->mem_ctx, sizeof(LSA_PRIV_ENTRY), (PRIV_ALL_INDEX-enum_context));
 	if (entries==NULL)
 		return NT_STATUS_NO_MEMORY;
 
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/rpc_server/srv_samr_nt.c samba-2.2.3a/source/rpc_server/srv_samr_nt.c
--- samba-2.2.3a.orig/source/rpc_server/srv_samr_nt.c	2002-02-03 01:46:51.000000000 +0100
+++ samba-2.2.3a/source/rpc_server/srv_samr_nt.c	2005-03-20 12:07:25.000000000 +0100
@@ -175,8 +175,8 @@ static NTSTATUS load_sampwd_entries(stru
 		if (info->disp_info.num_user_account % MAX_SAM_ENTRIES == 0) {
 		
 			DEBUG(10,("load_sampwd_entries: allocating more memory\n"));
-			pwd_array=(DISP_USER_INFO *)Realloc(info->disp_info.disp_user_info, 
-			                  (info->disp_info.num_user_account+MAX_SAM_ENTRIES)*sizeof(DISP_USER_INFO));
+			pwd_array=(DISP_USER_INFO *)realloc_array(info->disp_info.disp_user_info, 
+			                  (info->disp_info.num_user_account+MAX_SAM_ENTRIES), sizeof(DISP_USER_INFO));
 
 			if (pwd_array==NULL)
 				return NT_STATUS_NO_MEMORY;
@@ -214,7 +214,7 @@ static int setup_fake_group_map(GROUP_MA
 	static BOOL group_map_init;
 	extern DOM_SID global_sam_sid;
 
-	*ret_map = (GROUP_MAP *)malloc(sizeof(GROUP_MAP)*2);
+	*ret_map = (GROUP_MAP *)malloc_array(sizeof(GROUP_MAP), 2);
 	if (!ret_map)
 		return 2;
 	
@@ -268,7 +268,7 @@ static NTSTATUS load_group_domain_entrie
 
 	info->disp_info.num_group_account=group_entries;
 
-	grp_array=(DISP_GROUP_INFO *)malloc(info->disp_info.num_group_account*sizeof(DISP_GROUP_INFO));
+	grp_array=(DISP_GROUP_INFO *)malloc_array(info->disp_info.num_group_account, sizeof(DISP_GROUP_INFO));
 
 	if (group_entries!=0 && grp_array==NULL) {
 		return NT_STATUS_NO_MEMORY;
@@ -557,9 +557,9 @@ static void make_user_sam_entry_list(TAL
 	if (num_sam_entries == 0)
 		return;
 
-	sam = (SAM_ENTRY *)talloc_zero(ctx, sizeof(SAM_ENTRY)*num_sam_entries);
+	sam = (SAM_ENTRY *)talloc_zero_array(ctx, sizeof(SAM_ENTRY), num_sam_entries);
 
-	uni_name = (UNISTR2 *)talloc_zero(ctx, sizeof(UNISTR2)*num_sam_entries);
+	uni_name = (UNISTR2 *)talloc_zero_array(ctx, sizeof(UNISTR2), num_sam_entries);
 
 	if (sam == NULL || uni_name == NULL) {
 		DEBUG(0, ("NULL pointers in SAMR_R_QUERY_DISPINFO\n"));
@@ -644,9 +644,9 @@ static void make_group_sam_entry_list(TA
 	if (num_sam_entries == 0)
 		return;
 
-	sam = (SAM_ENTRY *)talloc_zero(ctx, sizeof(SAM_ENTRY)*num_sam_entries);
+	sam = (SAM_ENTRY *)talloc_zero_array(ctx, sizeof(SAM_ENTRY), num_sam_entries);
 
-	uni_name = (UNISTR2 *)talloc_zero(ctx, sizeof(UNISTR2)*num_sam_entries);
+	uni_name = (UNISTR2 *)talloc_zero_array(ctx, sizeof(UNISTR2), num_sam_entries);
 
 	if (sam == NULL || uni_name == NULL) {
 		DEBUG(0, ("NULL pointers in SAMR_R_QUERY_DISPINFO\n"));
@@ -991,7 +991,7 @@ NTSTATUS _samr_query_dispinfo(pipes_stru
 	switch (q_u->switch_level) {
 	case 0x1:
 		if (max_entries) {
-			if (!(ctr->sam.info1 = (SAM_DISPINFO_1 *)talloc_zero(p->mem_ctx,max_entries*sizeof(SAM_DISPINFO_1))))
+			if (!(ctr->sam.info1 = (SAM_DISPINFO_1 *)talloc_zero_array(p->mem_ctx,max_entries, sizeof(SAM_DISPINFO_1))))
 				return NT_STATUS_NO_MEMORY;
 		}
 		disp_ret = init_sam_dispinfo_1(p->mem_ctx, ctr->sam.info1, max_entries, enum_context, info->disp_info.disp_user_info);
@@ -1000,7 +1000,7 @@ NTSTATUS _samr_query_dispinfo(pipes_stru
 		break;
 	case 0x2:
 		if (max_entries) {
-			if (!(ctr->sam.info2 = (SAM_DISPINFO_2 *)talloc_zero(p->mem_ctx,max_entries*sizeof(SAM_DISPINFO_2))))
+			if (!(ctr->sam.info2 = (SAM_DISPINFO_2 *)talloc_zero_array(p->mem_ctx,max_entries, sizeof(SAM_DISPINFO_2))))
 				return NT_STATUS_NO_MEMORY;
 		}
 		disp_ret = init_sam_dispinfo_2(p->mem_ctx, ctr->sam.info2, max_entries, enum_context, info->disp_info.disp_user_info);
@@ -1009,7 +1009,7 @@ NTSTATUS _samr_query_dispinfo(pipes_stru
 		break;
 	case 0x3:
 		if (max_entries) {
-			if (!(ctr->sam.info3 = (SAM_DISPINFO_3 *)talloc_zero(p->mem_ctx,max_entries*sizeof(SAM_DISPINFO_3))))
+			if (!(ctr->sam.info3 = (SAM_DISPINFO_3 *)talloc_zero_array(p->mem_ctx,max_entries, sizeof(SAM_DISPINFO_3))))
 				return NT_STATUS_NO_MEMORY;
 		}
 		disp_ret = init_sam_dispinfo_3(p->mem_ctx, ctr->sam.info3, max_entries, enum_context, info->disp_info.disp_group_info);
@@ -1018,7 +1018,7 @@ NTSTATUS _samr_query_dispinfo(pipes_stru
 		break;
 	case 0x4:
 		if (max_entries) {
-			if (!(ctr->sam.info4 = (SAM_DISPINFO_4 *)talloc_zero(p->mem_ctx,max_entries*sizeof(SAM_DISPINFO_4))))
+			if (!(ctr->sam.info4 = (SAM_DISPINFO_4 *)talloc_zero_array(p->mem_ctx,max_entries, sizeof(SAM_DISPINFO_4))))
 				return NT_STATUS_NO_MEMORY;
 		}
 		disp_ret = init_sam_dispinfo_4(p->mem_ctx, ctr->sam.info4, max_entries, enum_context, info->disp_info.disp_user_info);
@@ -1027,7 +1027,7 @@ NTSTATUS _samr_query_dispinfo(pipes_stru
 		break;
 	case 0x5:
 		if (max_entries) {
-			if (!(ctr->sam.info5 = (SAM_DISPINFO_5 *)talloc_zero(p->mem_ctx,max_entries*sizeof(SAM_DISPINFO_5))))
+			if (!(ctr->sam.info5 = (SAM_DISPINFO_5 *)talloc_zero_array(p->mem_ctx,max_entries, sizeof(SAM_DISPINFO_5))))
 				return NT_STATUS_NO_MEMORY;
 		}
 		disp_ret = init_sam_dispinfo_5(p->mem_ctx, ctr->sam.info5, max_entries, enum_context, info->disp_info.disp_group_info);
@@ -1287,11 +1287,11 @@ static BOOL make_samr_lookup_rids(TALLOC
 	*pp_hdr_name = NULL;
 
 	if (num_names != 0) {
-		hdr_name = (UNIHDR *)talloc_zero(ctx, sizeof(UNIHDR)*num_names);
+		hdr_name = (UNIHDR *)talloc_zero_array(ctx, sizeof(UNIHDR), num_names);
 		if (hdr_name == NULL)
 			return False;
 
-		uni_name = (UNISTR2 *)talloc_zero(ctx,sizeof(UNISTR2)*num_names);
+		uni_name = (UNISTR2 *)talloc_zero_array(ctx,sizeof(UNISTR2), num_names);
 		if (uni_name == NULL)
 			return False;
 	}
@@ -1337,7 +1337,7 @@ NTSTATUS _samr_lookup_rids(pipes_struct 
 	}
 
 	if (num_rids) {
-		if ((group_attrs = (uint32 *)talloc_zero(p->mem_ctx, num_rids * sizeof(uint32))) == NULL)
+		if ((group_attrs = (uint32 *)talloc_zero_array(p->mem_ctx, num_rids, sizeof(uint32))) == NULL)
 			return NT_STATUS_NO_MEMORY;
 	}
 
@@ -2062,8 +2062,8 @@ static BOOL make_enum_domains(TALLOC_CTX
 	if (num_sam_entries == 0)
 		return True;
 
-	sam = (SAM_ENTRY *)talloc_zero(ctx, sizeof(SAM_ENTRY)*num_sam_entries);
-	uni_name = (UNISTR2 *)talloc_zero(ctx, sizeof(UNISTR2)*num_sam_entries);
+	sam = (SAM_ENTRY *)talloc_zero_array(ctx, sizeof(SAM_ENTRY), num_sam_entries);
+	uni_name = (UNISTR2 *)talloc_zero_array(ctx, sizeof(UNISTR2), num_sam_entries);
 
 	if (sam == NULL || uni_name == NULL)
 		return False;
@@ -2581,7 +2581,7 @@ NTSTATUS _samr_query_useraliases(pipes_s
 	int num_rids;
 
 	num_rids = 1;
-	rid=(uint32 *)talloc_zero(p->mem_ctx, num_rids*sizeof(uint32));
+	rid=(uint32 *)talloc_zero_array(p->mem_ctx, num_rids, sizeof(uint32));
 	if (rid == NULL)
 		return NT_STATUS_NO_MEMORY;
 
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/rpc_server/srv_spoolss_nt.c samba-2.2.3a/source/rpc_server/srv_spoolss_nt.c
--- samba-2.2.3a.orig/source/rpc_server/srv_spoolss_nt.c	2005-03-20 12:05:55.000000000 +0100
+++ samba-2.2.3a/source/rpc_server/srv_spoolss_nt.c	2005-03-20 12:07:25.000000000 +0100
@@ -986,7 +986,7 @@ BOOL convert_devicemode(char *printernam
 	if ((devmode->driverextra != 0) && (devmode->private != NULL)) {
 		SAFE_FREE(nt_devmode->private);
 		nt_devmode->driverextra=devmode->driverextra;
-		if((nt_devmode->private=(uint8 *)malloc(nt_devmode->driverextra * sizeof(uint8))) == NULL)
+		if((nt_devmode->private=(uint8 *)malloc_array(nt_devmode->driverextra, sizeof(uint8))) == NULL)
 			return False;
 		memcpy(nt_devmode->private, devmode->private, nt_devmode->driverextra);
 	}
@@ -1153,7 +1153,7 @@ static BOOL getprinterdata_printer_serve
 		
 	if (!strcmp(value, "W3SvcInstalled")) {
 		*type = 0x4;
-		if((*data = (uint8 *)talloc_zero(ctx, 4*sizeof(uint8) )) == NULL)
+		if((*data = (uint8 *)talloc_zero_array(ctx, 4, sizeof(uint8) )) == NULL)
 			return False;
 		*needed = 0x4;			
 		return True;
@@ -1199,7 +1199,7 @@ static BOOL getprinterdata_printer_serve
 		pstring string="You are using a Samba server";
 		*type = 0x1;			
 		*needed = 2*(strlen(string)+1);		
-		if((*data  = (uint8 *)talloc(ctx, ((*needed > in_size) ? *needed:in_size) *sizeof(uint8))) == NULL)
+		if((*data  = (uint8 *)talloc_array(ctx, ((*needed > in_size) ? *needed:in_size), sizeof(uint8))) == NULL)
 			return False;
 		memset(*data, 0, (*needed > in_size) ? *needed:in_size);
 		
@@ -1215,7 +1215,7 @@ static BOOL getprinterdata_printer_serve
 		pstring string="Windows NT x86";
 		*type = 0x1;			
 		*needed = 2*(strlen(string)+1);	
-		if((*data  = (uint8 *)talloc(ctx, ((*needed > in_size) ? *needed:in_size) *sizeof(uint8))) == NULL)
+		if((*data  = (uint8 *)talloc_array(ctx, ((*needed > in_size) ? *needed:in_size), sizeof(uint8))) == NULL)
 			return False;
 		memset(*data, 0, (*needed > in_size) ? *needed:in_size);
 		for (i=0; i<strlen(string); i++) {
@@ -1264,7 +1264,7 @@ static BOOL getprinterdata_printer(pipes
 	DEBUG(5,("getprinterdata_printer:allocating %d\n", in_size));
 
 	if (in_size) {
-		if((*data  = (uint8 *)talloc(ctx, in_size *sizeof(uint8) )) == NULL) {
+		if((*data  = (uint8 *)talloc_array(ctx, in_size, sizeof(uint8) )) == NULL) {
 			return False;
 		}
 
@@ -1335,7 +1335,7 @@ WERROR _spoolss_getprinterdata(pipes_str
 		DEBUG(5, ("value not found, allocating %d\n", *out_size));
 		/* reply this param doesn't exist */
 		if (*out_size) {
-			if((*data=(uint8 *)talloc_zero(p->mem_ctx, *out_size*sizeof(uint8))) == NULL)
+			if((*data=(uint8 *)talloc_zero_array(p->mem_ctx, *out_size, sizeof(uint8))) == NULL)
 				return WERR_NOMEM;
 		} else {
 			*data = NULL;
@@ -2259,7 +2259,7 @@ static BOOL construct_notify_printer_inf
 		if (!search_notify(type, field, &j) )
 			continue;
 
-		if((tid=(SPOOL_NOTIFY_INFO_DATA *)Realloc(info->data, (info->count+1)*sizeof(SPOOL_NOTIFY_INFO_DATA))) == NULL) {
+		if((tid=(SPOOL_NOTIFY_INFO_DATA *)realloc_array(info->data, (info->count+1), sizeof(SPOOL_NOTIFY_INFO_DATA))) == NULL) {
 			DEBUG(2,("construct_notify_printer_info: failed to enlarge buffer info->data!\n"));
 			return False;
 		}
@@ -2314,7 +2314,7 @@ static BOOL construct_notify_jobs_info(p
 		if (!search_notify(type, field, &j) )
 			continue;
 
-		if((tid=Realloc(info->data, (info->count+1)*sizeof(SPOOL_NOTIFY_INFO_DATA))) == NULL) {
+		if((tid=realloc_array(info->data, (info->count+1), sizeof(SPOOL_NOTIFY_INFO_DATA))) == NULL) {
 			DEBUG(2,("construct_notify_jobs_info: failed to enlarg buffer info->data!\n"));
 			return False;
 		}
@@ -2968,7 +2968,7 @@ static WERROR enum_all_printers_info_1(u
 			DEBUG(4,("Found a printer in smb.conf: %s[%x]\n", lp_servicename(snum), snum));
 				
 			if (construct_printer_info_1(flags, &current_prt, snum)) {
-				if((tp=Realloc(printers, (*returned +1)*sizeof(PRINTER_INFO_1))) == NULL) {
+				if((tp=realloc_array(printers, (*returned +1), sizeof(PRINTER_INFO_1))) == NULL) {
 					DEBUG(2,("enum_all_printers_info_1: failed to enlarge printers buffer!\n"));
 					SAFE_FREE(printers);
 					*returned=0;
@@ -3117,7 +3117,7 @@ static WERROR enum_all_printers_info_2(N
 			DEBUG(4,("Found a printer in smb.conf: %s[%x]\n", lp_servicename(snum), snum));
 				
 			if (construct_printer_info_2(&current_prt, snum)) {
-				if((tp=Realloc(printers, (*returned +1)*sizeof(PRINTER_INFO_2))) == NULL) {
+				if((tp=realloc_array(printers, (*returned +1), sizeof(PRINTER_INFO_2))) == NULL) {
 					DEBUG(2,("enum_all_printers_info_2: failed to enlarge printers buffer!\n"));
 					SAFE_FREE(printers);
 					*returned = 0;
@@ -3630,7 +3630,7 @@ static void init_unistr_array(uint16 **u
 		if (strlen(v) == 0) break;
 		slprintf(line, sizeof(line)-1, "\\\\%s%s", servername, v);
 		DEBUGADD(6,("%d:%s:%d\n", i, line, strlen(line)));
-		if((tuary=Realloc(*uni_array, (j+strlen(line)+2)*sizeof(uint16))) == NULL) {
+		if((tuary=realloc_array(*uni_array, (j+strlen(line)+2), sizeof(uint16))) == NULL) {
 			DEBUG(2,("init_unistr_array: Realloc error\n" ));
 			return;
 		} else
@@ -4993,7 +4993,7 @@ static WERROR enumjobs_level1(print_queu
 	JOB_INFO_1 *info;
 	int i;
 	
-	info=(JOB_INFO_1 *)malloc(*returned*sizeof(JOB_INFO_1));
+	info=(JOB_INFO_1 *)malloc_array(*returned, sizeof(JOB_INFO_1));
 	if (info==NULL) {
 		SAFE_FREE(queue);
 		*returned=0;
@@ -5041,7 +5041,7 @@ static WERROR enumjobs_level2(print_queu
 	int i;
 	WERROR result;
 	
-	info=(JOB_INFO_2 *)malloc(*returned*sizeof(JOB_INFO_2));
+	info=(JOB_INFO_2 *)malloc_array(*returned, sizeof(JOB_INFO_2));
 	if (info==NULL) {
 		*returned=0;
 		return WERR_NOMEM;
@@ -5221,7 +5221,7 @@ static WERROR enumprinterdrivers_level1(
 			return WERR_NOMEM;
 
 		if(ndrivers != 0) {
-			if((tdi1=(DRIVER_INFO_1 *)Realloc(driver_info_1, (*returned+ndrivers) * sizeof(DRIVER_INFO_1))) == NULL) {
+			if((tdi1=(DRIVER_INFO_1 *)realloc_array(driver_info_1, (*returned+ndrivers), sizeof(DRIVER_INFO_1))) == NULL) {
 				DEBUG(0,("enumprinterdrivers_level1: failed to enlarge driver info buffer!\n"));
 				SAFE_FREE(driver_info_1);
 				SAFE_FREE(list);
@@ -5301,7 +5301,7 @@ static WERROR enumprinterdrivers_level2(
 			return WERR_NOMEM;
 
 		if(ndrivers != 0) {
-			if((tdi2=(DRIVER_INFO_2 *)Realloc(driver_info_2, (*returned+ndrivers) * sizeof(DRIVER_INFO_2))) == NULL) {
+			if((tdi2=(DRIVER_INFO_2 *)realloc_array(driver_info_2, (*returned+ndrivers), sizeof(DRIVER_INFO_2))) == NULL) {
 				DEBUG(0,("enumprinterdrivers_level2: failed to enlarge driver info buffer!\n"));
 				SAFE_FREE(driver_info_2);
 				SAFE_FREE(list);
@@ -5382,7 +5382,7 @@ static WERROR enumprinterdrivers_level3(
 			return WERR_NOMEM;
 
 		if(ndrivers != 0) {
-			if((tdi3=(DRIVER_INFO_3 *)Realloc(driver_info_3, (*returned+ndrivers) * sizeof(DRIVER_INFO_3))) == NULL) {
+			if((tdi3=(DRIVER_INFO_3 *)realloc_array(driver_info_3, (*returned+ndrivers), sizeof(DRIVER_INFO_3))) == NULL) {
 				DEBUG(0,("enumprinterdrivers_level3: failed to enlarge driver info buffer!\n"));
 				SAFE_FREE(driver_info_3);
 				SAFE_FREE(list);
@@ -5535,7 +5535,7 @@ WERROR _spoolss_enumforms(pipes_struct *
 
 	switch (level) {
 	case 1:
-		if ((forms_1=(FORM_1 *)malloc(*numofforms * sizeof(FORM_1))) == NULL) {
+		if ((forms_1=(FORM_1 *)malloc_array(*numofforms, sizeof(FORM_1))) == NULL) {
 			*numofforms=0;
 			return WERR_NOMEM;
 		}
@@ -5738,7 +5738,7 @@ static WERROR enumports_level_1(NEW_BUFF
 		close(fd);
 
 		if(numlines) {
-			if((ports=(PORT_INFO_1 *)malloc( numlines * sizeof(PORT_INFO_1) )) == NULL) {
+			if((ports=(PORT_INFO_1 *)malloc_array( numlines, sizeof(PORT_INFO_1) )) == NULL) {
 				DEBUG(10,("Returning WERR_NOMEM [%s]\n", 
 					  werror_str(WERR_NOMEM)));
 				file_lines_free(qlines);
@@ -5837,7 +5837,7 @@ static WERROR enumports_level_2(NEW_BUFF
 		close(fd);
 
 		if(numlines) {
-			if((ports=(PORT_INFO_2 *)malloc( numlines * sizeof(PORT_INFO_2) )) == NULL) {
+			if((ports=(PORT_INFO_2 *)malloc_array( numlines, sizeof(PORT_INFO_2) )) == NULL) {
 				file_lines_free(qlines);
 				return WERR_NOMEM;
 			}
@@ -6310,7 +6310,7 @@ WERROR _spoolss_enumprinterdata(pipes_st
 		   problems unmarshalling the response */
 
 		*out_max_value_len=(in_value_len/sizeof(uint16));
-		if((*out_value=(uint16 *)talloc_zero(p->mem_ctx, in_value_len*sizeof(uint8))) == NULL)
+		if((*out_value=(uint16 *)talloc_zero_array(p->mem_ctx, in_value_len, sizeof(uint8))) == NULL)
 			return WERR_NOMEM;
 
 		*out_value_len = (uint32)dos_PutUniCode((char *)*out_value, "", in_value_len, True);
@@ -6318,7 +6318,7 @@ WERROR _spoolss_enumprinterdata(pipes_st
 		/* the data is counted in bytes */
 		*out_max_data_len = in_data_len;
 		*out_data_len = in_data_len;
-		if((*data_out=(uint8 *)talloc_zero(p->mem_ctx, in_data_len*sizeof(uint8))) == NULL)
+		if((*data_out=(uint8 *)talloc_zero_array(p->mem_ctx, in_data_len, sizeof(uint8))) == NULL)
 			return WERR_NOMEM;
 
 		return WERR_NO_MORE_ITEMS;
@@ -6336,7 +6336,7 @@ WERROR _spoolss_enumprinterdata(pipes_st
 	 */
 	
 	*out_max_value_len=(in_value_len/sizeof(uint16));
-	if((*out_value=(uint16 *)talloc_zero(p->mem_ctx,in_value_len*sizeof(uint8))) == NULL) {
+	if((*out_value=(uint16 *)talloc_zero_array(p->mem_ctx,in_value_len, sizeof(uint8))) == NULL) {
 		SAFE_FREE(data);
 		return WERR_NOMEM;
 	}
@@ -6347,7 +6347,7 @@ WERROR _spoolss_enumprinterdata(pipes_st
 
 	/* the data is counted in bytes */
 	*out_max_data_len=in_data_len;
-	if((*data_out=(uint8 *)talloc_zero(p->mem_ctx, in_data_len*sizeof(uint8))) == NULL) {
+	if((*data_out=(uint8 *)talloc_zero_array(p->mem_ctx, in_data_len, sizeof(uint8))) == NULL) {
 		SAFE_FREE(data);
 		return WERR_NOMEM;
 	}
@@ -7140,7 +7140,7 @@ WERROR _spoolss_getprinterdataex(pipes_s
 		
 		/* reply this param doesn't exist */
 		if (*out_size) {
-			if((*data=(uint8 *)talloc_zero(p->mem_ctx, *out_size*sizeof(uint8))) == NULL)
+			if((*data=(uint8 *)talloc_zero_array(p->mem_ctx, *out_size, sizeof(uint8))) == NULL)
 				return WERR_NOMEM;
 		} else {
 			*data = NULL;
@@ -7325,7 +7325,11 @@ WERROR _spoolss_enumprinterdataex(pipes_
 		uint32			add_len = 0;
 
 		DEBUG(10,("retrieved value number [%d] [%s]\n", num_entries, value));
-
+		if((num_entries+1) >= UINT_MAX/sizeof(PRINTER_ENUM_VALUES))
+		{
+			DEBUG(0,("_spoolss_enumprinterdataex: integer overflow detected.\n"));
+			goto done;
+		}
 		if ((ptr=talloc_realloc(p->mem_ctx, enum_values, (num_entries+1) * sizeof(PRINTER_ENUM_VALUES))) == NULL)
 		{
 			DEBUG(0,("talloc_realloc failed to allocate more memory!\n"));
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/rpc_server/srv_srvsvc_nt.c samba-2.2.3a/source/rpc_server/srv_srvsvc_nt.c
--- samba-2.2.3a.orig/source/rpc_server/srv_srvsvc_nt.c	2005-03-20 12:05:55.000000000 +0100
+++ samba-2.2.3a/source/rpc_server/srv_srvsvc_nt.c	2005-03-20 12:07:25.000000000 +0100
@@ -462,7 +462,7 @@ static BOOL init_srv_share_info_ctr(pipe
 		SRV_SHARE_INFO_1 *info1;
 		int i = 0;
 
-		info1 = talloc(ctx, num_entries * sizeof(SRV_SHARE_INFO_1));
+		info1 = talloc_array(ctx, num_entries, sizeof(SRV_SHARE_INFO_1));
 
 		for (snum = *resume_hnd; snum < num_services; snum++) {
 			if (lp_browseable(snum) && lp_snum_ok(snum) && (all_shares || !is_admin_share(snum)) ) {
@@ -479,7 +479,7 @@ static BOOL init_srv_share_info_ctr(pipe
 		SRV_SHARE_INFO_2 *info2;
 		int i = 0;
 
-		info2 = talloc(ctx, num_entries * sizeof(SRV_SHARE_INFO_2));
+		info2 = talloc_array(ctx, num_entries, sizeof(SRV_SHARE_INFO_2));
 
 		for (snum = *resume_hnd; snum < num_services; snum++) {
 			if (lp_browseable(snum) && lp_snum_ok(snum) && (all_shares || !is_admin_share(snum)) ) {
@@ -496,7 +496,7 @@ static BOOL init_srv_share_info_ctr(pipe
 		SRV_SHARE_INFO_502 *info502;
 		int i = 0;
 
-		info502 = talloc(ctx, num_entries * sizeof(SRV_SHARE_INFO_502));
+		info502 = talloc_array(ctx, num_entries, sizeof(SRV_SHARE_INFO_502));
 
 		for (snum = *resume_hnd; snum < num_services; snum++) {
 			if (lp_browseable(snum) && lp_snum_ok(snum) && (all_shares || !is_admin_share(snum)) ) {
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/rpc_server/srv_util.c samba-2.2.3a/source/rpc_server/srv_util.c
--- samba-2.2.3a.orig/source/rpc_server/srv_util.c	2002-02-03 01:46:52.000000000 +0100
+++ samba-2.2.3a/source/rpc_server/srv_util.c	2005-03-20 12:07:25.000000000 +0100
@@ -95,7 +95,7 @@ int make_dom_gids(TALLOC_CTX *ctx, char 
        count++)
     ;
 
-  gids = (DOM_GID *)talloc(ctx, sizeof(DOM_GID) * count );
+  gids = (DOM_GID *)talloc_array(ctx, sizeof(DOM_GID), count );
   if(!gids)
   {
     DEBUG(0,("make_dom_gids: talloc fail !\n"));
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/rpcclient/cmd_lsarpc.c samba-2.2.3a/source/rpcclient/cmd_lsarpc.c
--- samba-2.2.3a.orig/source/rpcclient/cmd_lsarpc.c	2002-02-03 01:46:52.000000000 +0100
+++ samba-2.2.3a/source/rpcclient/cmd_lsarpc.c	2005-03-20 12:07:25.000000000 +0100
@@ -141,7 +141,7 @@ static NTSTATUS cmd_lsa_lookup_sids(stru
 
 	/* Convert arguments to sids */
 
-	sids = (DOM_SID *)talloc(mem_ctx, sizeof(DOM_SID) * (argc - 1));
+	sids = (DOM_SID *)talloc_array(mem_ctx, sizeof(DOM_SID), (argc - 1));
 
 	if (!sids) {
 		printf("could not allocate memory for %d sids\n", argc - 1);
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/rpcclient/cmd_samr.c samba-2.2.3a/source/rpcclient/cmd_samr.c
--- samba-2.2.3a.orig/source/rpcclient/cmd_samr.c	2002-02-03 01:46:53.000000000 +0100
+++ samba-2.2.3a/source/rpcclient/cmd_samr.c	2005-03-20 12:07:25.000000000 +0100
@@ -759,7 +759,7 @@ static NTSTATUS cmd_samr_lookup_names(st
 	/* Look up names */
 
 	num_names = argc - 1;
-	names = (char **)talloc(mem_ctx, sizeof(char *) * num_names);
+	names = (char **)talloc_array(mem_ctx, sizeof(char *), num_names);
 
 	for (i = 0; i < argc - 1; i++)
 		names[i] = argv[i + 1];
@@ -820,7 +820,7 @@ static NTSTATUS cmd_samr_lookup_rids(str
 	/* Look up rids */
 
 	num_rids = argc - 1;
-	rids = (uint32 *)talloc(mem_ctx, sizeof(uint32) * num_rids);
+	rids = (uint32 *)talloc_array(mem_ctx, sizeof(uint32), num_rids);
 
 	for (i = 0; i < argc - 1; i++)
                 sscanf(argv[i + 1], "%i", &rids[i]);
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/rpcclient/cmd_spoolss.c samba-2.2.3a/source/rpcclient/cmd_spoolss.c
--- samba-2.2.3a.orig/source/rpcclient/cmd_spoolss.c	2002-02-03 01:46:53.000000000 +0100
+++ samba-2.2.3a/source/rpcclient/cmd_spoolss.c	2005-03-20 12:07:25.000000000 +0100
@@ -991,7 +991,7 @@ static BOOL init_drv_info_3_members (
 	/* allocate the space; add one extra slot for a terminating NULL.
 	   Each filename is NULL terminated and the end contains a double
 	   NULL */
-	if ((info->dependentfiles=(uint16*)talloc(mem_ctx, (len+1)*sizeof(uint16))) == NULL)
+	if ((info->dependentfiles=(uint16*)talloc_array(mem_ctx, (len+1), sizeof(uint16))) == NULL)
 	{
 		DEBUG(0,("init_drv_info_3_members: Unable to malloc memory for dependenfiles\n"));
 		return False;
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/rpcclient/rpcclient.c samba-2.2.3a/source/rpcclient/rpcclient.c
--- samba-2.2.3a.orig/source/rpcclient/rpcclient.c	2002-02-03 01:46:53.000000000 +0100
+++ samba-2.2.3a/source/rpcclient/rpcclient.c	2005-03-20 12:07:25.000000000 +0100
@@ -54,7 +54,7 @@ static char **completion_fn(const char *
 	if (!commands) 
 		return NULL;
 
-	matches = (char **)malloc(sizeof(matches[0])*MAX_COMPLETIONS);
+	matches = (char **)malloc_array(sizeof(matches[0]), MAX_COMPLETIONS);
 	if (!matches) return NULL;
 
 	matches[count++] = strdup(text);
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/smbd/ipc.c samba-2.2.3a/source/smbd/ipc.c
--- samba-2.2.3a.orig/source/smbd/ipc.c	2005-03-20 12:02:22.000000000 +0100
+++ samba-2.2.3a/source/smbd/ipc.c	2005-03-20 12:07:24.000000000 +0100
@@ -419,7 +419,7 @@ int reply_trans(connection_struct *conn,
 
 	if (suwcnt) {
 		int i;
-		if((setup = (uint16 *)malloc(suwcnt*sizeof(uint16))) == NULL) {
+		if((setup = (uint16 *)malloc_array(suwcnt, sizeof(uint16))) == NULL) {
 			DEBUG(0,("reply_trans: setup malloc fail for %u bytes !\n", (unsigned int)(suwcnt * sizeof(uint16))));
 			SAFE_FREE(data);
 			SAFE_FREE(params);
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/smbd/lanman.c samba-2.2.3a/source/smbd/lanman.c
--- samba-2.2.3a.orig/source/smbd/lanman.c	2005-03-20 12:05:55.000000000 +0100
+++ samba-2.2.3a/source/smbd/lanman.c	2005-03-20 12:07:25.000000000 +0100
@@ -1009,17 +1009,17 @@ static BOOL api_DosPrintQEnum(connection
     if (lp_snum_ok(i) && lp_print_ok(i) && lp_browseable(i))
       queuecnt++;
   if (uLevel > 0) {
-    if((queue = (print_queue_struct**)malloc(queuecnt*sizeof(print_queue_struct*))) == NULL) {
+    if((queue = (print_queue_struct**)malloc_array(queuecnt, sizeof(print_queue_struct*))) == NULL) {
       DEBUG(0,("api_DosPrintQEnum: malloc fail !\n"));
       return False;
     }
     memset(queue,0,queuecnt*sizeof(print_queue_struct*));
-    if((status = (print_status_struct*)malloc(queuecnt*sizeof(print_status_struct))) == NULL) {
+    if((status = (print_status_struct*)malloc_array(queuecnt, sizeof(print_status_struct))) == NULL) {
       DEBUG(0,("api_DosPrintQEnum: malloc fail !\n"));
       return False;
     }
     memset(status,0,queuecnt*sizeof(print_status_struct));
-    if((subcntarr = (int*)malloc(queuecnt*sizeof(int))) == NULL) {
+    if((subcntarr = (int*)malloc_array(queuecnt, sizeof(int))) == NULL) {
       DEBUG(0,("api_DosPrintQEnum: malloc fail !\n"));
       return False;
     }
@@ -1136,7 +1136,7 @@ static int get_server_info(uint32 server
 
       alloced += 10;
       ts = (struct srv_info_struct *)
-	Realloc(*servers,sizeof(**servers)*alloced);
+	realloc_array(*servers, sizeof(**servers), alloced);
       if (!ts) {
         DEBUG(0,("get_server_info: failed to enlarge servers info struct!\n"));
         return(0);
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/smbd/password.c samba-2.2.3a/source/smbd/password.c
--- samba-2.2.3a.orig/source/smbd/password.c	2005-03-20 12:02:22.000000000 +0100
+++ samba-2.2.3a/source/smbd/password.c	2005-03-20 12:07:24.000000000 +0100
@@ -196,7 +196,7 @@ NT_USER_TOKEN *create_nt_token(uid_t uid
 	if (sup_tok && sup_tok->num_sids)
 		num_sids += sup_tok->num_sids;
 
-	if ((token->user_sids = (DOM_SID *)malloc( num_sids*sizeof(DOM_SID))) == NULL) {
+	if ((token->user_sids = (DOM_SID *)malloc_array( num_sids, sizeof(DOM_SID))) == NULL) {
 		SAFE_FREE(token);
 		return NULL;
 	}
@@ -1602,7 +1602,7 @@ BOOL domain_client_validate( char *user,
     }
  
     ptok->num_sids = (size_t)info3.num_groups2;
-    if ((ptok->user_sids = (DOM_SID *)malloc( sizeof(DOM_SID) * ptok->num_sids )) == NULL) {
+    if ((ptok->user_sids = (DOM_SID *)malloc_array( sizeof(DOM_SID), ptok->num_sids )) == NULL) {
       DEBUG(0, ("domain_client_validate: Out of memory allocating group SIDS\n"));
       SAFE_FREE(ptok);
       return False;
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/smbd/posix_acls.c samba-2.2.3a/source/smbd/posix_acls.c
--- samba-2.2.3a.orig/source/smbd/posix_acls.c	2002-02-03 01:46:56.000000000 +0100
+++ samba-2.2.3a/source/smbd/posix_acls.c	2005-03-20 12:07:25.000000000 +0100
@@ -1927,7 +1927,7 @@ size_t get_nt_acl(files_struct *fsp, SEC
 	}
 
 	/* Allocate the ace list. */
-	if ((nt_ace_list = (SEC_ACE *)malloc((num_acls + num_dir_acls)* sizeof(SEC_ACE))) == NULL) {
+	if ((nt_ace_list = (SEC_ACE *)malloc_array((num_acls + num_dir_acls), sizeof(SEC_ACE))) == NULL) {
 		DEBUG(0,("get_nt_acl: Unable to malloc space for nt_ace_list.\n"));
 		goto done;
 	}
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/smbd/sec_ctx.c samba-2.2.3a/source/smbd/sec_ctx.c
--- samba-2.2.3a.orig/source/smbd/sec_ctx.c	2002-02-03 01:46:56.000000000 +0100
+++ samba-2.2.3a/source/smbd/sec_ctx.c	2005-03-20 12:07:25.000000000 +0100
@@ -146,7 +146,7 @@ int get_current_groups(int *p_ngroups, g
 	if (ngroups <= 0)
 		return -1;
 
-	if((groups = (gid_t *)malloc(sizeof(gid_t)*ngroups)) == NULL) {
+	if((groups = (gid_t *)malloc_array(sizeof(gid_t),ngroups)) == NULL) {
 		DEBUG(0,("setup_groups malloc fail !\n"));
 		return -1;
 	}
@@ -286,7 +286,7 @@ BOOL push_sec_ctx(void)
 	ctx_p->ngroups = sys_getgroups(0, NULL);
 
 	if (ctx_p->ngroups != 0) {
-		if (!(ctx_p->groups = malloc(ctx_p->ngroups * sizeof(gid_t)))) {
+		if (!(ctx_p->groups = malloc_array(ctx_p->ngroups, sizeof(gid_t)))) {
 			DEBUG(0, ("Out of memory in push_sec_ctx()\n"));
 			delete_nt_token(&ctx_p->token);
 			return False;
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/smbd/uid.c samba-2.2.3a/source/smbd/uid.c
--- samba-2.2.3a.orig/source/smbd/uid.c	2002-02-03 01:46:57.000000000 +0100
+++ samba-2.2.3a/source/smbd/uid.c	2005-03-20 12:07:25.000000000 +0100
@@ -394,7 +394,7 @@ void add_supplementary_nt_login_groups(i
 
 	total_groups = current_n_groups + ptok->num_sids;
  
-	final_groups = (gid_t *)malloc(total_groups * sizeof(gid_t));
+	final_groups = (gid_t *)malloc_array(total_groups, sizeof(gid_t));
 	if (!final_groups) {
 		DEBUG(0,("add_supplementary_nt_login_groups: Failed to malloc new groups.\n"));
 		delete_nt_token(&new_tok);
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/smbwrapper/smbw_dir.c samba-2.2.3a/source/smbwrapper/smbw_dir.c
--- samba-2.2.3a.orig/source/smbwrapper/smbw_dir.c	2002-02-03 01:46:57.000000000 +0100
+++ samba-2.2.3a/source/smbwrapper/smbw_dir.c	2005-03-20 12:07:25.000000000 +0100
@@ -80,8 +80,8 @@ static void smbw_dir_add(struct file_inf
 	DEBUG(5,("%s\n", finfo->name));
 
 	if (cur_dir->malloced == cur_dir->count) {
-		cur_dir->list = (struct file_info *)Realloc(cur_dir->list, 
-							    sizeof(cur_dir->list[0])*
+		cur_dir->list = (struct file_info *)realloc_array(cur_dir->list, 
+							    sizeof(cur_dir->list[0]),
 							    (cur_dir->count+100));
 		if (!cur_dir->list) {
 			/* oops */
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/tdb/tdb.c samba-2.2.3a/source/tdb/tdb.c
--- samba-2.2.3a.orig/source/tdb/tdb.c	2002-02-03 01:46:57.000000000 +0100
+++ samba-2.2.3a/source/tdb/tdb.c	2005-03-20 12:07:25.000000000 +0100
@@ -1514,6 +1514,14 @@ TDB_CONTEXT *tdb_open_ex(const char *nam
 	tdb->map_size = st.st_size;
 	tdb->device = st.st_dev;
 	tdb->inode = st.st_ino;
+	if(tdb->header.hash_size == INT_MAX || tdb->header.hash_size >= INT_MAX/sizeof(tdb->locked[0]))
+	{
+		TDB_LOG((tdb, 2, "tdb_open_ex: "
+			"integer overflow detected for %s\n",
+			name));
+		errno = ENOMEM;
+		goto fail;
+	}
 	tdb->locked = calloc(tdb->header.hash_size+1, sizeof(tdb->locked[0]));
 	if (!tdb->locked) {
 		TDB_LOG((tdb, 2, "tdb_open_ex: "
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/tests/getgroups.c samba-2.2.3a/source/tests/getgroups.c
--- samba-2.2.3a.orig/source/tests/getgroups.c	1999-12-13 14:27:53.000000000 +0100
+++ samba-2.2.3a/source/tests/getgroups.c	2005-03-20 12:07:25.000000000 +0100
@@ -32,7 +32,7 @@ main()
 	if (ngroups <= 0)
 		ngroups = 32;
 
-	igroups = (int *)malloc(sizeof(int)*ngroups);
+	igroups = (int *)malloc_array(sizeof(int), ngroups);
 
 	for (i=0;i<ngroups;i++)
 		igroups[i] = 0x42424242;
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/utils/locktest.c samba-2.2.3a/source/utils/locktest.c
--- samba-2.2.3a.orig/source/utils/locktest.c	2002-02-03 01:46:57.000000000 +0100
+++ samba-2.2.3a/source/utils/locktest.c	2005-03-20 12:07:25.000000000 +0100
@@ -375,7 +375,7 @@ static void test_locks(char *share[NSERV
 	ZERO_STRUCT(fnum);
 	ZERO_STRUCT(cli);
 
-	recorded = (struct record *)malloc(sizeof(*recorded) * numops);
+	recorded = (struct record *)malloc_array(sizeof(*recorded), numops);
 
 	for (n=0; n<numops; n++) {
 		if (n < sizeof(preset) / sizeof(preset[0])) {
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/utils/locktest2.c samba-2.2.3a/source/utils/locktest2.c
--- samba-2.2.3a.orig/source/utils/locktest2.c	2002-02-03 01:46:57.000000000 +0100
+++ samba-2.2.3a/source/utils/locktest2.c	2005-03-20 12:07:25.000000000 +0100
@@ -433,7 +433,7 @@ static void test_locks(char *share1, cha
 	ZERO_STRUCT(fnum);
 	ZERO_STRUCT(cli);
 
-	recorded = (struct record *)malloc(sizeof(*recorded) * numops);
+	recorded = (struct record *)malloc_array(sizeof(*recorded), numops);
 
 	for (n=0; n<numops; n++) {
 		recorded[n].conn = random() % NCONNECTIONS;
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/utils/make_smbcodepage.c samba-2.2.3a/source/utils/make_smbcodepage.c
--- samba-2.2.3a.orig/source/utils/make_smbcodepage.c	2002-02-03 01:46:57.000000000 +0100
+++ samba-2.2.3a/source/utils/make_smbcodepage.c	2005-03-20 12:07:25.000000000 +0100
@@ -67,10 +67,16 @@ static int clean_data( char **buf, size_
   pstring linebuf;
   char *p = *buf;
   int num_lines = 0;
-  char *newbuf = (char *)malloc( *size + 1);
+  char *newbuf;
   char *newbuf_p = NULL;
 
-  if(newbuf == NULL)
+  if(*size == UINT_MAX)
+  {
+    fprintf(stderr, "%s: size %lu is too big (integer overflow).\n", prog_name, *size);
+    exit(1);
+  }
+
+  if((newbuf = (char *)malloc( *size + 1)) == NULL)
   {
     fprintf(stderr, "%s: malloc fail for size %d.\n", prog_name, *size + 1);
     exit(1);
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/utils/make_unicodemap.c samba-2.2.3a/source/utils/make_unicodemap.c
--- samba-2.2.3a.orig/source/utils/make_unicodemap.c	2002-02-03 01:46:57.000000000 +0100
+++ samba-2.2.3a/source/utils/make_unicodemap.c	2005-03-20 12:07:25.000000000 +0100
@@ -66,10 +66,18 @@ static size_t clean_data( char **buf, si
   pstring linebuf;
   char *p = *buf;
   size_t num_lines = 0;
-  char *newbuf = (char *)malloc( *size + 1);
+  char *newbuf;
   char *newbuf_p = NULL;
 
-  if(newbuf == NULL) {
+
+  if(*size == UINT_MAX)
+  {
+    fprintf(stderr, "%s: size %lu is too big (integer overflow).\n", prog_name, *size);
+    exit(1);
+  }
+
+  if((newbuf = (char *)malloc( *size + 1)) == NULL)
+  {
     fprintf(stderr, "%s: malloc fail for size %u.\n", prog_name, (unsigned int)(*size + 1));
     exit(1);
   }
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/utils/nsstest.c samba-2.2.3a/source/utils/nsstest.c
--- samba-2.2.3a.orig/source/utils/nsstest.c	2002-02-01 23:22:26.000000000 +0100
+++ samba-2.2.3a/source/utils/nsstest.c	2005-03-20 12:07:25.000000000 +0100
@@ -242,7 +242,7 @@ static void nss_test_initgroups(char *na
 	gid_t *groups = NULL;
 	int i;
 
-	groups = (gid_t *)malloc(size * sizeof(gid_t));
+	groups = (gid_t *)malloc_array(size, sizeof(gid_t));
 	groups[0] = gid;
 
 	nss_initgroups(name, gid, &groups, &start, &size);
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/utils/smbcacls.c samba-2.2.3a/source/utils/smbcacls.c
--- samba-2.2.3a.orig/source/utils/smbcacls.c	2002-02-03 01:46:57.000000000 +0100
+++ samba-2.2.3a/source/utils/smbcacls.c	2005-03-20 12:07:25.000000000 +0100
@@ -324,7 +324,7 @@ static BOOL add_ace(SEC_ACL **the_acl, S
 		return True;
 	}
 
-	aces = calloc(1+(*the_acl)->num_aces,sizeof(SEC_ACE));
+	aces = calloc_array(1+(*the_acl)->num_aces,sizeof(SEC_ACE));
 	memcpy(aces, (*the_acl)->ace, (*the_acl)->num_aces * sizeof(SEC_ACE));
 	memcpy(aces+(*the_acl)->num_aces, ace, sizeof(SEC_ACE));
 	new = make_sec_acl(ctx,(*the_acl)->revision,1+(*the_acl)->num_aces, aces);
diff -u -p -Nr --exclude CVS samba-2.2.3a.orig/source/web/cgi.c samba-2.2.3a/source/web/cgi.c
--- samba-2.2.3a.orig/source/web/cgi.c	2002-02-03 01:46:58.000000000 +0100
+++ samba-2.2.3a/source/web/cgi.c	2005-03-20 12:07:25.000000000 +0100
@@ -94,8 +94,20 @@ static char *grab_line(FILE *f, int *cl)
 	
 		if (i == len) {
 			char *ret2;
-			if (len == 0) len = 1024;
-			else len *= 2;
+			if (len == 0)
+			{
+				len = 1024;
+			}
+			else
+			{
+				if(len >= INT_MAX/2)
+				{
+					if(ret)
+						free(ret);
+					return NULL;
+				}
+				len *= 2;
+			}
 			ret2 = (char *)Realloc(ret, len);
 			if (!ret2) return ret;
 			ret = ret2;
